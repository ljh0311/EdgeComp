{% extends "base.html" %}

{% block title %}Baby Monitor - Repair Tools{% endblock %}

{% block extra_css %}
<style>
    /* Main container styles */
    .repair-container {
        padding: 2rem;
        background-color: #1a1a1a;
        min-height: calc(100vh - 56px);
    }

    /* Card styles */
    .repair-card {
        background-color: #2d2d2d;
        border: 1px solid #404040;
        margin-bottom: 20px;
        transition: all 0.3s ease;
        border-radius: 8px;
        overflow: hidden;
    }
    
    .repair-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }

    .repair-card-header {
        background-color: #333;
        padding: 1rem;
        border-bottom: 1px solid #404040;
    }
    
    .repair-card-body {
        padding: 1.5rem;
    }
    
    .repair-icon {
        font-size: 2.5rem;
        margin-bottom: 15px;
        color: #0dcaf0;
        transition: transform 0.3s ease;
    }
    
    .repair-card:hover .repair-icon {
        transform: scale(1.1);
    }
    
    .repair-title {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 10px;
        color: #fff;
    }
    
    .repair-description {
        color: #aaa;
        margin-bottom: 15px;
        font-size: 0.9rem;
        line-height: 1.5;
    }
    
    /* Button styles */
    .repair-button {
        width: 100%;
        margin-bottom: 10px;
        transition: all 0.3s ease;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        font-weight: 500;
    }

    .repair-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .repair-button:active {
        transform: translateY(0);
    }

    .repair-button:last-child {
        margin-bottom: 0;
    }

    /* Status styles */
    .status-container {
        background-color: #2d2d2d;
        border: 1px solid #404040;
        border-radius: 8px;
        padding: 1rem;
        margin-top: 20px;
        max-height: 300px;
        overflow-y: auto;
    }

    .status-message {
        display: flex;
        align-items: center;
        padding: 10px;
        margin-bottom: 8px;
        border-radius: 6px;
        background-color: rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
    }

    .status-message:hover {
        transform: translateX(5px);
    }

    .status-icon {
        margin-right: 10px;
        font-size: 1.2rem;
    }

    .status-time {
        color: #aaa;
        margin-right: 10px;
        font-size: 0.85rem;
    }

    .status-text {
        color: #fff;
        flex-grow: 1;
    }

    /* Status message types */
    .status-message.success {
        background-color: rgba(25, 135, 84, 0.1);
        border-left: 4px solid #198754;
    }

    .status-message.warning {
        background-color: rgba(255, 193, 7, 0.1);
        border-left: 4px solid #ffc107;
    }

    .status-message.error {
        background-color: rgba(220, 53, 69, 0.1);
        border-left: 4px solid #dc3545;
    }

    .status-message.info {
        background-color: rgba(13, 202, 240, 0.1);
        border-left: 4px solid #0dcaf0;
    }

    /* Form control styles */
    .form-select-dark {
        background-color: #333;
        border: 1px solid #404040;
        color: #fff;
        padding: 0.5rem;
        width: 100%;
        border-radius: 4px;
        margin-bottom: 10px;
        transition: all 0.3s ease;
    }

    .form-select-dark:focus {
        border-color: #0dcaf0;
        box-shadow: 0 0 0 0.25rem rgba(13, 202, 240, 0.25);
    }

    .form-select-dark option {
        background-color: #333;
        color: #fff;
        padding: 8px;
    }

    /* System info styles */
    .system-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }

    .system-info-item {
        background-color: #252525;
        padding: 1rem;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .system-info-label {
        color: #aaa;
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
    }

    .system-info-value {
        color: #fff;
        font-size: 1.2rem;
        font-weight: 500;
    }

    /* Progress bar styles */
    .progress-bar-container {
        width: 100%;
        background-color: #333;
        height: 8px;
        border-radius: 4px;
        overflow: hidden;
        margin-top: 0.5rem;
    }

    .progress-bar-fill {
        height: 100%;
        transition: width 0.3s ease;
    }

    .progress-bar-fill.good {
        background-color: #198754;
    }

    .progress-bar-fill.warning {
        background-color: #ffc107;
    }

    .progress-bar-fill.danger {
        background-color: #dc3545;
    }

    /* Audio visualization styles */
    .audio-visualizer {
        width: 100%;
        height: 100px;
        background-color: #252525;
        border-radius: 8px;
        margin-top: 1rem;
        position: relative;
        overflow: hidden;
    }

    .audio-bar {
        position: absolute;
        bottom: 0;
        background-color: #0dcaf0;
        width: 3px;
        margin-right: 2px;
        transition: height 0.1s ease;
    }

    /* Model selection styles */
    .model-card {
        background-color: #252525;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .model-card:hover {
        transform: translateY(-3px);
        background-color: #2a2a2a;
    }

    .model-card.active {
        border: 1px solid #0dcaf0;
    }

    .model-name {
        color: #fff;
        font-weight: 500;
        margin-bottom: 0.5rem;
    }
    
    .model-info {
        color: #aaa;
        font-size: 0.9rem;
    }

    .model-badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.8rem;
        margin-right: 0.5rem;
        background-color: #333;
        color: #fff;
    }
</style>
{% endblock %}

{% block content %}
<div class="repair-container">
    <div class="row">
        <!-- System Status Section -->
        <div class="col-lg-8 mb-4">
            <div class="repair-card">
                <div class="repair-card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-pc-display"></i> System Status</h5>
                    <button class="btn btn-sm btn-outline-info" id="refreshStatus">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                </div>
                <div class="repair-card-body">
                    <div class="system-info-grid">
                        <div class="system-info-item">
                            <div class="system-info-label">CPU Usage</div>
                            <div class="system-info-value" id="cpuUsage">0%</div>
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill" id="cpuBar"></div>
            </div>
        </div>
                        <div class="system-info-item">
                            <div class="system-info-label">Memory Usage</div>
                            <div class="system-info-value" id="memoryUsage">0%</div>
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill" id="memoryBar"></div>
                    </div>
                    </div>
                        <div class="system-info-item">
                            <div class="system-info-label">Camera Status</div>
                            <div class="system-info-value" id="cameraStatus">
                                <span class="badge bg-secondary">Unknown</span>
                            </div>
                        </div>
                        <div class="system-info-item">
                            <div class="system-info-label">Audio Status</div>
                            <div class="system-info-value" id="audioStatus">
                                <span class="badge bg-secondary">Unknown</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions Section -->
        <div class="col-lg-4 mb-4">
            <div class="repair-card">
                <div class="repair-card-header">
                    <h5 class="mb-0"><i class="bi bi-lightning"></i> Quick Actions</h5>
                </div>
                <div class="repair-card-body">
                    <button class="repair-button btn btn-info" id="restartCamera">
                        <i class="bi bi-camera"></i> Restart Camera
                    </button>
                    <button class="repair-button btn btn-info" id="restartAudio">
                        <i class="bi bi-mic"></i> Restart Audio
                    </button>
                    <button class="repair-button btn btn-warning" id="checkSystem">
                        <i class="bi bi-search"></i> System Check
                    </button>
                    <button class="repair-button btn btn-danger" id="restartSystem">
                        <i class="bi bi-arrow-repeat"></i> Restart System
                    </button>
                </div>
            </div>
                    </div>

        <!-- Audio Configuration Section -->
        <div class="col-lg-6 mb-4">
            <div class="repair-card">
                <div class="repair-card-header">
                    <h5 class="mb-0"><i class="bi bi-mic"></i> Audio Configuration</h5>
                </div>
                <div class="repair-card-body">
                    <div class="mb-3">
                        <label class="form-label text-light">Input Device</label>
                        <select class="form-select-dark" id="microphoneSelect">
                            <option value="">Loading microphones...</option>
                        </select>
                    </div>
                    <div class="audio-visualizer" id="audioVisualizer">
                        <!-- Audio bars will be added dynamically -->
                    </div>
                    <div class="mt-3">
                        <button class="repair-button btn btn-primary" id="testMicrophone">
                            <i class="bi bi-play-circle"></i> Test Microphone
                        </button>
                    </div>
                </div>
                        </div>
                    </div>

        <!-- Emotion Model Section -->
        <div class="col-lg-6 mb-4">
            <div class="repair-card">
                <div class="repair-card-header">
                    <h5 class="mb-0"><i class="bi bi-emoji-smile"></i> Emotion Models</h5>
                    </div>
                <div class="repair-card-body">
                    <div id="modelList">
                        <!-- Model cards will be added dynamically -->
                    </div>
                    <button class="repair-button btn btn-primary mt-3" id="switchModel" disabled>
                        <i class="bi bi-check2-circle"></i> Apply Selected Model
                    </button>
                </div>
            </div>
        </div>

        <!-- Status Log Section -->
        <div class="col-12">
            <div class="repair-card">
                <div class="repair-card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-journal-text"></i> Status Log</h5>
                    <div>
                        <button class="btn btn-sm btn-outline-danger me-2" id="clearLog">
                            <i class="bi bi-trash"></i> Clear
                        </button>
                        <button class="btn btn-sm btn-outline-info" id="exportLog">
                            <i class="bi bi-download"></i> Export
                        </button>
                    </div>
                </div>
                <div class="status-container" id="statusLog">
                    <!-- Status messages will be added dynamically -->
            </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Socket.IO connection
    const socket = io();
    
    // Initialize variables
    let selectedModel = null;
    let audioVisualizerBars = [];
    const NUM_BARS = 32;
    
    // DOM Elements
    const statusLog = document.getElementById('statusLog');
    const microphoneSelect = document.getElementById('microphoneSelect');
    const modelList = document.getElementById('modelList');
    const switchModelBtn = document.getElementById('switchModel');
    const audioVisualizer = document.getElementById('audioVisualizer');
    
    // Initialize audio visualizer
    function initAudioVisualizer() {
        audioVisualizerBars = [];
        audioVisualizer.innerHTML = '';
        
        const barWidth = audioVisualizer.clientWidth / NUM_BARS - 2;
        
        for (let i = 0; i < NUM_BARS; i++) {
            const bar = document.createElement('div');
            bar.className = 'audio-bar';
            bar.style.left = `${i * (barWidth + 2)}px`;
            bar.style.width = `${barWidth}px`;
            audioVisualizer.appendChild(bar);
            audioVisualizerBars.push(bar);
        }
    }
    
    // Update audio visualizer
    function updateAudioVisualizer(level) {
        const normalizedLevel = (level + 60) / 60; // Convert -60dB to 0dB range to 0-1
        audioVisualizerBars.forEach((bar, index) => {
            const height = Math.random() * normalizedLevel * 100;
            bar.style.height = `${height}px`;
        });
    }
    
    // Add status message
    function addStatusMessage(type, message) {
        const now = new Date().toLocaleTimeString();
        const messageDiv = document.createElement('div');
        messageDiv.className = `status-message ${type}`;
        
        let icon = '';
        switch(type) {
            case 'success': icon = 'check-circle-fill'; break;
            case 'warning': icon = 'exclamation-triangle-fill'; break;
            case 'error': icon = 'x-circle-fill'; break;
            default: icon = 'info-circle-fill';
        }
        
        messageDiv.innerHTML = `
            <i class="bi bi-${icon} status-icon"></i>
            <span class="status-time">${now}</span>
            <span class="status-text">${message}</span>
        `;
        
        statusLog.insertBefore(messageDiv, statusLog.firstChild);
    }
    
    // Update system status
    function updateSystemStatus(data) {
        // Update CPU usage
        const cpuUsage = document.getElementById('cpuUsage');
        const cpuBar = document.getElementById('cpuBar');
        if (cpuUsage && cpuBar && data.cpu_usage !== undefined) {
            cpuUsage.textContent = `${data.cpu_usage.toFixed(1)}%`;
            cpuBar.style.width = `${data.cpu_usage}%`;
            cpuBar.className = `progress-bar-fill ${getStatusClass(data.cpu_usage)}`;
        }
        
        // Update memory usage
        const memoryUsage = document.getElementById('memoryUsage');
        const memoryBar = document.getElementById('memoryBar');
        if (memoryUsage && memoryBar && data.memory_usage !== undefined) {
            memoryUsage.textContent = `${data.memory_usage.toFixed(1)}%`;
            memoryBar.style.width = `${data.memory_usage}%`;
            memoryBar.className = `progress-bar-fill ${getStatusClass(data.memory_usage)}`;
        }
        
        // Update status badges
        updateStatusBadge('cameraStatus', data.camera_status);
        updateStatusBadge('audioStatus', data.audio_status);
    }
    
    // Update status badge
    function updateStatusBadge(elementId, status) {
        const element = document.getElementById(elementId);
        if (element) {
            let badgeClass = 'bg-secondary';
            let text = 'Unknown';
            
            switch(status) {
                case 'active':
                case 'connected':
                    badgeClass = 'bg-success';
                    text = 'Active';
                    break;
                case 'inactive':
                case 'disconnected':
                    badgeClass = 'bg-danger';
                    text = 'Inactive';
                    break;
                case 'error':
                    badgeClass = 'bg-warning';
                    text = 'Error';
                    break;
            }
            
            element.innerHTML = `<span class="badge ${badgeClass}">${text}</span>`;
        }
    }
    
    // Get status class based on value
    function getStatusClass(value) {
        if (value < 50) return 'good';
        if (value < 80) return 'warning';
        return 'danger';
    }
    
    // Socket.IO event handlers
    socket.on('connect', () => {
        addStatusMessage('success', 'Connected to server');
        fetchMicrophones();
        fetchModels();
    });
    
    socket.on('disconnect', () => {
        addStatusMessage('error', 'Disconnected from server');
    });
    
    socket.on('audio_level_update', (data) => {
        updateAudioVisualizer(data.level);
    });

    // Add new Socket.IO event handler for model changes
    socket.on('emotion_model_changed', (modelInfo) => {
        addStatusMessage('success', `Switched to model: ${modelInfo.name}`);
        fetchModels(); // Refresh the model list
    });
    
    // Initialize page
    document.addEventListener('DOMContentLoaded', () => {
        initAudioVisualizer();
        
        // Event listeners for buttons
        document.getElementById('refreshStatus').addEventListener('click', fetchSystemStatus);
        document.getElementById('restartCamera').addEventListener('click', () => runRepairTool('restart_camera'));
        document.getElementById('restartAudio').addEventListener('click', () => runRepairTool('restart_audio'));
        document.getElementById('checkSystem').addEventListener('click', () => runRepairTool('check_system'));
        document.getElementById('restartSystem').addEventListener('click', () => runRepairTool('restart_system'));
        document.getElementById('testMicrophone').addEventListener('click', testMicrophone);
        document.getElementById('clearLog').addEventListener('click', clearStatusLog);
        document.getElementById('exportLog').addEventListener('click', exportStatusLog);
        document.getElementById('switchModel').addEventListener('click', switchSelectedModel);
        
        // Initial system status check
        fetchSystemStatus();
    });
    
    // Fetch microphones
    function fetchMicrophones() {
    fetch('/repair/api/audio/microphones')
        .then(response => response.json())
        .then(data => {
                microphoneSelect.innerHTML = '';
            
            if (data.microphones && data.microphones.length > 0) {
                data.microphones.forEach(mic => {
                    const option = document.createElement('option');
                    option.value = mic.id;
                    option.textContent = mic.name;
                        if (mic.id === data.current_microphone) {
                        option.selected = true;
                    }
                        microphoneSelect.appendChild(option);
                    });
                } else {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'No microphones available';
                    option.disabled = true;
                    microphoneSelect.appendChild(option);
            }
        })
        .catch(error => {
                console.error('Error fetching microphones:', error);
                addStatusMessage('error', 'Failed to fetch microphones');
            });
    }
    
    // Fetch emotion models
    function fetchModels() {
        fetch('/api/emotion/models')
            .then(response => response.json())
            .then(data => {
                modelList.innerHTML = '';
                
                if (data.models && data.models.length > 0) {
                    data.models.forEach((model, index) => {
                        const modelCard = document.createElement('div');
                        modelCard.className = `model-card ${model.id === data.current_model.id ? 'active' : ''}`;
                        modelCard.innerHTML = `
                            <div class="model-name">${model.name}</div>
                            <div class="model-info">
                                <span class="model-badge">${model.type}</span>
                                <span class="text-muted">${model.emotions.join(', ')}</span>
                            </div>
                        `;
                        
                        // Store the model data in the card element
                        modelCard.dataset.modelId = model.id;
                        modelCard.dataset.modelIndex = index;
                        
                        modelCard.addEventListener('click', () => selectModel(model, modelCard));
                        modelList.appendChild(modelCard);
                        
                        if (model.id === data.current_model.id) {
                            selectedModel = model;
                            switchModelBtn.disabled = true;
                        }
                    });
                } else {
                    modelList.innerHTML = '<div class="text-muted">No models available</div>';
                    switchModelBtn.disabled = true;
                }
            })
            .catch(error => {
                console.error('Error fetching models:', error);
                addStatusMessage('error', 'Failed to fetch emotion models');
            });
    }
    
    // Select model
    function selectModel(model, card) {
        // Remove active class from all cards
        document.querySelectorAll('.model-card').forEach(card => card.classList.remove('active'));
        // Add active class to selected card
        card.classList.add('active');
        selectedModel = model;
        switchModelBtn.disabled = false;
        
        // Show selection feedback
        addStatusMessage('info', `Selected model: ${model.name}`);
    }
    
    // Switch to selected model
    function switchSelectedModel() {
        if (!selectedModel) {
            addStatusMessage('warning', 'Please select a model first');
            return;
        }
        
        // Disable the switch button while processing
        switchModelBtn.disabled = true;
        
        fetch('/api/emotion/switch_model', {
                method: 'POST',
                headers: {
                'Content-Type': 'application/json'
                },
            body: JSON.stringify({ model_id: selectedModel.id })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                addStatusMessage('success', data.message);
                // Model list will be refreshed by the emotion_model_changed event
                } else {
                addStatusMessage('error', data.message || 'Failed to switch model');
                switchModelBtn.disabled = false;
                }
            })
            .catch(error => {
            console.error('Error switching model:', error);
            addStatusMessage('error', 'Failed to switch emotion model');
            switchModelBtn.disabled = false;
            });
        }

    // Run repair tool
    function runRepairTool(tool) {
        fetch('/repair/run', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ tool })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                addStatusMessage('success', data.message);
                fetchSystemStatus();
            } else {
                addStatusMessage('error', data.error || 'Operation failed');
            }
        })
        .catch(error => {
            console.error('Error running repair tool:', error);
            addStatusMessage('error', 'Failed to run repair tool');
        });
    }
    
    // Test microphone
    function testMicrophone() {
        const micId = microphoneSelect.value;
        if (!micId) {
            addStatusMessage('warning', 'Please select a microphone');
            return;
        }
        
        fetch('/repair/api/audio/test', {
                method: 'POST',
                headers: {
                'Content-Type': 'application/json'
                },
            body: JSON.stringify({ microphone_id: micId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                addStatusMessage('success', 'Microphone test successful');
                } else {
                addStatusMessage('error', data.error || 'Microphone test failed');
                }
            })
            .catch(error => {
            console.error('Error testing microphone:', error);
            addStatusMessage('error', 'Failed to test microphone');
        });
    }
    
    // Clear status log
    function clearStatusLog() {
        statusLog.innerHTML = '';
        addStatusMessage('info', 'Status log cleared');
    }
    
    // Export status log
    function exportStatusLog() {
        const messages = Array.from(statusLog.children).map(msg => {
            const time = msg.querySelector('.status-time').textContent;
            const text = msg.querySelector('.status-text').textContent;
            return `${time}: ${text}`;
        }).join('\n');
        
        const blob = new Blob([messages], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `repair_log_${new Date().toISOString().split('T')[0]}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        addStatusMessage('info', 'Status log exported');
    }
    
    // Fetch system status
    function fetchSystemStatus() {
    fetch('/repair/api/system/info')
        .then(response => response.json())
        .then(data => {
                updateSystemStatus(data);
                addStatusMessage('info', 'System status updated');
        })
        .catch(error => {
                console.error('Error fetching system status:', error);
                addStatusMessage('error', 'Failed to fetch system status');
            });
    }
</script>
{% endblock %} 