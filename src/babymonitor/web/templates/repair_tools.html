{% extends "base.html" %}

{% block title %}Baby Monitor - Repair Tools{% endblock %}

{% block extra_css %}
<style>
    .repair-card {
        background-color: #2d2d2d;
        border: 1px solid #404040;
        margin-bottom: 20px;
        transition: transform 0.2s;
    }
    
    .repair-card:hover {
        transform: translateY(-5px);
    }
    
    .repair-icon {
        font-size: 3rem;
        margin-bottom: 15px;
        color: #0dcaf0;
    }
    
    .repair-title {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 10px;
        color: #fff;
    }
    
    .repair-description {
        color: #aaa;
        margin-bottom: 15px;
    }
    
    .repair-button {
        width: 100%;
        margin-bottom: 10px;
    }

    .repair-button:last-child {
        margin-bottom: 0;
    }

    .status-container {
        background-color: #2d2d2d;
        border: 1px solid #404040;
        border-radius: 4px;
        padding: 1rem;
        margin-top: 20px;
    }

    .status-message {
        display: flex;
        align-items: center;
        padding: 8px;
        margin-bottom: 8px;
        border-radius: 4px;
        background-color: rgba(0, 0, 0, 0.2);
    }

    .status-time {
        color: #aaa;
        margin-right: 10px;
        font-size: 0.9rem;
    }

    .status-text {
        color: #fff;
    }

    .status-message.success {
        background-color: rgba(25, 135, 84, 0.2);
        border-left: 4px solid #198754;
    }

    .status-message.warning {
        background-color: rgba(255, 193, 7, 0.2);
        border-left: 4px solid #ffc107;
    }

    .status-message.error {
        background-color: rgba(220, 53, 69, 0.2);
        border-left: 4px solid #dc3545;
    }

    .status-message.info {
        background-color: rgba(13, 202, 240, 0.2);
        border-left: 4px solid #0dcaf0;
    }

    .camera-select {
        background-color: #333;
        border: 1px solid #404040;
        color: #fff;
        padding: 0.5rem;
        margin-bottom: 10px;
        width: 100%;
        border-radius: 4px;
    }

    .camera-select option {
        background-color: #333;
        color: #fff;
    }

    .resolution-select {
        background-color: #333;
        border: 1px solid #404040;
        color: #fff;
        padding: 0.5rem;
        width: 100%;
        border-radius: 4px;
    }

    .resolution-select option {
        background-color: #333;
        color: #fff;
    }

    .system-info {
        color: #aaa;
        font-size: 0.9rem;
        margin-top: 10px;
    }

    .system-info strong {
        color: #fff;
    }

    .direct-feed-container {
        background-color: #1a1a1a;
        border-radius: 8px;
        padding: 1rem;
        margin-top: 20px;
        text-align: center;
    }

    .direct-feed-frame {
        max-width: 100%;
        border-radius: 4px;
        margin-bottom: 1rem;
    }

    .feed-stats {
        display: flex;
        justify-content: center;
        gap: 2rem;
        margin-bottom: 1rem;
        color: #aaa;
    }

    .feed-stat {
        text-align: center;
    }

    .feed-stat-value {
        font-size: 1.5rem;
        font-weight: bold;
        color: #0dcaf0;
    }

    .feed-stat-label {
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .feed-controls {
        display: flex;
        justify-content: center;
        gap: 1rem;
    }

    /* Dev tools specific styles */
    .dev-card {
        margin-bottom: 20px;
        transition: transform 0.2s;
    }
    
    .dev-card:hover {
        transform: translateY(-5px);
    }
    
    .dev-icon {
        font-size: 3rem;
        margin-bottom: 15px;
        color: #fd7e14;
    }
    
    .dev-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        padding: 5px 10px;
        background-color: #dc3545;
        color: white;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: bold;
    }

    .memory-info {
        background-color: #252525;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }

    .memory-bar {
        height: 8px;
        background-color: #333;
        border-radius: 4px;
        overflow: hidden;
        margin: 10px 0;
    }

    .memory-bar-fill {
        height: 100%;
        background-color: #0dcaf0;
        border-radius: 4px;
        transition: width 0.3s ease;
    }

    .memory-text {
        display: flex;
        justify-content: space-between;
        color: #aaa;
    }

    .resolution-info {
        font-size: 0.8rem;
        color: #aaa;
        margin-top: 5px;
    }

    .resolution-warning {
        color: #ffc107;
        font-size: 0.8rem;
        margin-top: 5px;
        display: none;
    }

    .resolution-select option:disabled {
        color: #666;
        font-style: italic;
    }

    .stream-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        margin-top: 15px;
        padding: 10px;
        background-color: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
    }

    .stream-stat {
        text-align: center;
    }

    .stream-stat-value {
        font-size: 1.2rem;
        font-weight: bold;
        color: #0dcaf0;
    }

    .stream-stat-label {
        font-size: 0.8rem;
        color: #aaa;
        text-transform: uppercase;
    }

    .status-badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .status-active {
        background-color: rgba(25, 135, 84, 0.2);
        color: #198754;
    }

    .status-warning {
        background-color: rgba(255, 193, 7, 0.2);
        color: #ffc107;
    }

    .status-error {
        background-color: rgba(220, 53, 69, 0.2);
        color: #dc3545;
    }

    /* Desktop app launcher button */
    .desktop-launcher {
        background-color: #2d2d2d;
        border: 1px solid #404040;
        border-radius: 8px;
        padding: 15px;
        text-align: center;
        margin-bottom: 20px;
        transition: transform 0.2s;
    }
    
    .desktop-launcher:hover {
        transform: translateY(-5px);
        background-color: #353535;
    }
    
    .launcher-icon {
        font-size: 2rem;
        color: #0dcaf0;
        margin-bottom: 10px;
    }
    
    .launcher-text {
        color: #fff;
        font-weight: bold;
        margin-bottom: 10px;
    }
    
    .launcher-description {
        color: #aaa;
        font-size: 0.9rem;
        margin-bottom: 15px;
    }

    .camera-list {
        max-height: 200px;
        overflow-y: auto;
    }
    
    .camera-item {
        background-color: #333;
        border: 1px solid #404040;
        border-radius: 4px;
        padding: 10px;
        margin-bottom: 10px;
    }
    
    .camera-item:last-child {
        margin-bottom: 0;
    }
    
    .camera-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 5px;
    }
    
    .camera-item-name {
        font-weight: bold;
        color: #fff;
    }
    
    .camera-item-status {
        font-size: 0.8rem;
    }
    
    .camera-item-controls {
        display: flex;
        gap: 5px;
    }
    
    .system-status-grid {
        display: grid;
        gap: 10px;
    }
    
    .status-item {
        background-color: #333;
        border-radius: 4px;
        padding: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .status-label {
        color: #aaa;
        font-size: 0.9rem;
    }
    
    .status-badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: 600;
    }
    
    .status-checking {
        background-color: #666;
        color: #fff;
    }
    
    .status-ok {
        background-color: #198754;
        color: #fff;
    }
    
    .status-warning {
        background-color: #ffc107;
        color: #000;
    }
    
    .status-error {
        background-color: #dc3545;
        color: #fff;
    }

    .dashboard-card {
        background-color: #2d2d2d;
        border: 1px solid #404040;
    }

    .card-header {
        background-color: #333;
        border-bottom: 1px solid #404040;
        color: #fff;
    }

    .card-body {
        color: #fff;
    }

    .form-control, .form-select {
        background-color: #1a1a1a;
        border-color: #404040;
        color: #fff;
    }

    .form-control:focus, .form-select:focus {
        background-color: #1a1a1a;
        border-color: #0dcaf0;
        color: #fff;
        box-shadow: 0 0 0 0.25rem rgba(13, 202, 240, 0.25);
    }

    .status-log {
        max-height: 300px;
        overflow-y: auto;
    }

    .log-entry {
        padding: 8px;
        border-bottom: 1px solid #404040;
        font-family: monospace;
    }

    .log-entry:last-child {
        border-bottom: none;
    }

    .log-time {
        color: #888;
        margin-right: 10px;
    }

    .log-entry.error {
        color: #dc3545;
    }

    .log-entry.success {
        color: #198754;
    }

    .log-entry.info {
        color: #0dcaf0;
    }

    .log-entry.warning {
        color: #ffc107;
    }

    .btn-group-sm > .btn {
        padding: 0.25rem 0.5rem;
    }

    #systemInfo table {
        margin-top: 1rem;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    #systemInfo th {
        background-color: #17a2b8 !important;
        color: white !important;
        font-weight: 600;
        text-align: center;
        padding: 0.5rem !important;
    }
    
    #systemInfo td {
        padding: 0.5rem !important;
        vertical-align: middle;
    }
    
    #systemInfo td:first-child {
        font-weight: 500;
        width: 40%;
    }
    
    #systemInfo tr:hover {
        background-color: rgba(255, 255, 255, 0.05);
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col">
            <h1 class="mb-3">Repair Tools</h1>
            {% if mode == "normal" %}
            <p class="text-muted">Use these tools to fix common issues with your Baby Monitor system.</p>
            {% elif dev_mode %}
            <p class="text-muted">Use these advanced tools to fix common issues and manage development settings for the Baby Monitor system.</p>
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i> Developer Mode is active. Additional tools are available below.
            </div>
            {% endif %}
        </div>
    </div>

    <div class="row">
        <!-- Advanced Repair & Installation Tool -->
        <div class="col-12 mb-4">
            <div class="card dashboard-card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-tools"></i> 
                        {% if mode == "normal" %}
                        Quick Fix Tool
                        {% else %}
                        Advanced Repair & Installation Tool
                        {% endif %}
                    </h5>
                </div>
                <div class="card-body">
                    {% if mode == "normal" %}
                    <p class="text-muted">Check and fix common issues with your Baby Monitor system.</p>
                    {% else %}
                    <p class="text-muted">Launch the desktop application for advanced repair options, system reinstallation, and more detailed diagnostics.</p>
                    {% endif %}
                    <div class="d-flex gap-2">
                        {% if mode == "normal" %}
                        <button class="btn btn-primary" onclick="checkInstallation()">
                            <i class="bi bi-check-circle"></i> Run Quick Check
                        </button>
                        <button class="btn btn-outline-info" onclick="launchDesktopApp()">
                            <i class="bi bi-window-desktop"></i> Run Repair App
                        </button>
                        {% else %}
                        <button class="btn btn-primary" onclick="launchDesktopApp()">
                            <i class="bi bi-window-desktop"></i> Launch Desktop App
                        </button>
                        <button class="btn btn-outline-info" onclick="checkInstallation()">
                            <i class="bi bi-check-circle"></i> Check Installation
                        </button>
                        {% endif %}
                    </div>
                    <div id="installStatus" class="mt-3"></div>
                </div>
            </div>
        </div>

        <!-- Camera Management -->
        <div class="col-md-4">
            <div class="card dashboard-card">
                <div class="card-header">
                    <i class="bi bi-camera"></i> 
                    {% if mode == "normal" %}
                    Camera Setup
                    {% else %}
                    Camera Management
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if mode == "normal" %}
                    <div class="mb-3">
                        <label for="cameraName" class="form-label">Camera Name</label>
                        <input type="text" class="form-control" id="cameraName" name="camera_name" placeholder="Baby Room Camera" required>
                    </div>
                    <div class="mb-3">
                        <label for="cameraType" class="form-label">Camera Type</label>
                        <select class="form-select" id="cameraType" name="camera_type" onchange="toggleCameraInput()">
                            <option value="webcam" selected>Webcam</option>
                            <option value="ip">IP Camera</option>
                        </select>
                    </div>
                    <div class="mb-3" id="webcamSection">
                        <label for="cameraUrl" class="form-label">Webcam Device</label>
                        <select class="form-select" id="cameraUrl" name="camera_url">
                            <option value="0">Main Camera (Default)</option>
                            <option value="1">Second Camera</option>
                            <option value="2">Third Camera</option>
                        </select>
                        <small class="form-text text-muted">Select the webcam you want to use</small>
                    </div>
                    <div class="mb-3" id="ipCameraSection" style="display: none;">
                        <label for="ipCameraUrl" class="form-label">IP Camera URL</label>
                        <input type="text" class="form-control" id="ipCameraUrl" name="ip_camera_url" placeholder="rtsp://username:password@192.168.1.100:554/stream">
                        <small class="form-text text-muted">Enter the full RTSP/HTTP URL for your IP camera</small>
                    </div>
                    {% else %}
                    <form id="cameraForm">
                        <div class="mb-3">
                            <label for="cameraName" class="form-label">Camera Name</label>
                            <input type="text" class="form-control" id="cameraName" name="camera_name" placeholder="Baby Room Camera" required>
                        </div>
                        <div class="mb-3">
                            <label for="cameraType" class="form-label">Camera Type</label>
                            <select class="form-select" id="cameraType" name="camera_type" onchange="toggleCameraInput()">
                                <option value="webcam" selected>Webcam</option>
                                <option value="ip">IP Camera</option>
                            </select>
                        </div>
                        <div class="mb-3" id="webcamSection">
                            <label for="cameraUrl" class="form-label">Webcam Device</label>
                            <select class="form-select" id="cameraUrl" name="camera_url">
                                <option value="0">Main Camera (Default)</option>
                                <option value="1">Second Camera</option>
                                <option value="2">Third Camera</option>
                            </select>
                            <small class="form-text text-muted">Select the webcam you want to use</small>
                        </div>
                        <div class="mb-3" id="ipCameraSection" style="display: none;">
                            <label for="ipCameraUrl" class="form-label">IP Camera URL</label>
                            <input type="text" class="form-control" id="ipCameraUrl" name="ip_camera_url" placeholder="rtsp://username:password@192.168.1.100:554/stream">
                            <small class="form-text text-muted">Enter the full RTSP/HTTP URL for your IP camera</small>
                        </div>
                    </form>
                    {% endif %}
                    <button type="button" class="btn btn-primary w-100" onclick="addCamera()">
                        <i class="bi bi-plus-circle"></i> 
                        {% if mode == "normal" %}
                        Set Up Camera
                        {% else %}
                        Add Camera
                        {% endif %}
                    </button>
                    
                    <div class="mt-4">
                        <h6 class="mb-3">Connected Cameras</h6>
                        <div id="cameraList" class="list-group">
                            <!-- Camera list will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Audio System -->
        <div class="col-md-4">
            <div class="card dashboard-card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-mic"></i> 
                        {% if mode == "normal" %}
                        Sound Settings
                        {% else %}
                        Audio System
                        {% endif %}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">
                            {% if mode == "normal" %}
                            Baby Sound Detection
                            {% else %}
                            Emotion Recognition Model
                            {% endif %}
                        </label>
                        <select class="form-select" name="model_select" id="modelSelect">
                            <option value="">Loading models...</option>
                        </select>
                        <div id="modelInfo" class="mt-2">
                            <small class="text-muted">
                                {% if mode == "normal" %}
                                Select a detection mode
                                {% else %}
                                Select a model to view information
                                {% endif %}
                            </small>
                        </div>
                    </div>
                    
                    <!-- Microphone Selection -->
                    <div class="mb-3">
                        <label class="form-label">
                            {% if mode == "normal" %}
                            Microphone
                            {% else %}
                            Audio Input Device
                            {% endif %}
                        </label>
                        <select class="form-select" name="microphone_select" id="microphoneSelect">
                            <option value="">Loading microphones...</option>
                        </select>
                        <div id="microphoneInfo" class="mt-2">
                            <small class="text-muted">Select the microphone you want to use for sound detection</small>
                        </div>
                    </div>
                    
                    <!-- Sound Quality Tips Toggle -->
                    <div class="mb-3">
                        <a class="text-info" data-bs-toggle="collapse" href="#soundQualityTips" role="button" aria-expanded="false">
                            <i class="bi bi-info-circle"></i> Sound Quality Tips
                        </a>
                        <div class="collapse mt-2" id="soundQualityTips">
                            <div class="card bg-dark">
                                <div class="card-body">
                                    <h6 class="text-info">Improving Sound Detection Quality:</h6>
                                    <ul class="small text-muted mb-0">
                                        <li>Position the microphone closer to the sound source</li>
                                        <li>Reduce background noise in the environment</li>
                                        <li>Use a higher quality microphone if available</li>
                                        <li>Ensure microphone is not obstructed or covered</li>
                                        <li>Adjust system volume levels if detection is too sensitive</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary w-100 mb-2" onclick="applyEmotionModel()">
                        <i class="bi bi-check2-circle"></i> 
                        {% if mode == "normal" %}
                        Save Settings
                        {% else %}
                        Apply Model
                        {% endif %}
                    </button>
                    <button class="btn btn-info w-100 mb-2" onclick="applyMicrophoneSelection()">
                        <i class="bi bi-mic"></i> Apply Microphone Selection
                    </button>
                    <button class="btn btn-info w-100 mb-2" onclick="testAudio()">
                        <i class="bi bi-play-circle"></i> Test Audio
                    </button>
                    <button class="btn btn-warning w-100" onclick="restartAudio()">
                        <i class="bi bi-arrow-clockwise"></i> 
                        {% if mode == "normal" %}
                        Reset Audio
                        {% else %}
                        Restart Audio
                        {% endif %}
                    </button>
                </div>
            </div>
        </div>

        <!-- System Control -->
        <div class="col-md-4">
            <div class="card dashboard-card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-gear"></i> 
                        {% if mode == "normal" %}
                        System Controls
                        {% else %}
                        System Control
                        {% endif %}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Camera System:</span>
                            <span id="cameraSystemStatus" class="badge bg-secondary">Unknown</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Audio System:</span>
                            <span id="audioSystemStatus" class="badge bg-secondary">Unknown</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>
                                {% if mode == "normal" %}
                                Movement Detection:
                                {% else %}
                                Person Detection:
                                {% endif %}
                            </span>
                            <span id="personDetectionStatus" class="badge bg-secondary">Unknown</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>
                                {% if mode == "normal" %}
                                Sound Detection:
                                {% else %}
                                Emotion Detection:
                                {% endif %}
                            </span>
                            <span id="emotionDetectionStatus" class="badge bg-secondary">Unknown</span>
                        </div>
                    </div>
                    <button class="btn btn-info w-100 mb-2" onclick="checkSystem()">
                        <i class="bi bi-search"></i> Check System
                    </button>
                    <button class="btn btn-warning w-100 mb-2" onclick="restartSystem()">
                        <i class="bi bi-arrow-clockwise"></i> Restart System
                    </button>
                    <button class="btn btn-danger w-100" onclick="stopSystem()">
                        <i class="bi bi-power"></i> 
                        {% if mode == "normal" %}
                        Stop Monitor
                        {% else %}
                        Stop System
                        {% endif %}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- System Information -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card dashboard-card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> System Information</h5>
                </div>
                <div class="card-body">
                    <div id="systemInfo">Loading system information...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Log -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card dashboard-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-journal-text"></i> 
                        {% if mode == "normal" %}
                        Activity Log
                        {% else %}
                        Status Log
                        {% endif %}
                    </h5>
                    <button class="btn btn-sm btn-outline-danger" onclick="clearLog()">
                        <i class="bi bi-trash"></i> Clear Log
                    </button>
                </div>
                <div class="card-body">
                    <div id="statusLog" class="status-log">
                        <!-- Status log entries will be added here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if dev_mode %}
    <!-- Developer Tools Section - Only visible in dev mode -->
    <div class="row mt-4">
        <h4 class="mb-3"><i class="bi bi-gear"></i> Developer Tools</h4>
        
        <!-- Metrics Tools -->
        <div class="col-md-4">
            <div class="card dev-card">
                <div class="dev-badge">Metrics</div>
                <div class="card-body text-center">
                    <i class="bi bi-graph-up dev-icon"></i>
                    <h5 class="dev-title">Metrics Tools</h5>
                    <p class="dev-description">Tools for managing and simulating metrics data.</p>
                    <button class="btn btn-outline-warning dev-button" data-command="clear_metrics">
                        <i class="bi bi-trash"></i> Clear Metrics History
                    </button>
                    <button class="btn btn-outline-warning dev-button" data-command="reset_alerts">
                        <i class="bi bi-trash"></i> Clear Alerts
                    </button>
                </div>
            </div>
        </div>

        <!-- Detection Simulation -->
        <div class="col-md-4">
            <div class="card dev-card">
                <div class="dev-badge">Simulation</div>
                <div class="card-body text-center">
                    <i class="bi bi-person-bounding-box dev-icon"></i>
                    <h5 class="dev-title">Detection Simulation</h5>
                    <p class="dev-description">Simulate person detection events.</p>
                    <div class="input-group mb-3">
                        <span class="input-group-text">Count</span>
                        <input type="number" id="detectionCount" class="form-control" value="1" min="0" max="10">
                    </div>
                    <button class="btn btn-outline-warning dev-button" data-command="simulate_detection">
                        <i class="bi bi-play"></i> Simulate Detection
                    </button>
                </div>
            </div>
        </div>

        <!-- Emotion Simulation -->
        <div class="col-md-4">
            <div class="card dev-card">
                <div class="dev-badge">Simulation</div>
                <div class="card-body text-center">
                    <i class="bi bi-emoji-smile dev-icon"></i>
                    <h5 class="dev-title">Emotion Simulation</h5>
                    <p class="dev-description">Simulate emotion detection events.</p>
                    <div class="input-group mb-3">
                        <span class="input-group-text">Emotion</span>
                        <select id="emotionType" class="form-select">
                            <option value="crying">Crying</option>
                            <option value="laughing">Laughing</option>
                            <option value="babbling">Babbling</option>
                            <option value="silence">Silence</option>
                        </select>
                    </div>
                    <div class="input-group mb-3">
                        <span class="input-group-text">Confidence</span>
                        <input type="range" id="emotionConfidence" class="form-range" min="0" max="1" step="0.1" value="0.8">
                        <span class="input-group-text" id="confidenceValue">80%</span>
                    </div>
                    <button class="btn btn-outline-warning dev-button" data-command="simulate_emotion">
                        <i class="bi bi-play"></i> Simulate Emotion
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
// API endpoints for our functions
if (typeof API === 'undefined') {
    // Only declare API if it doesn't already exist
    window.API = {
        cameras: {
            list: '/api/cameras/list',
            add: '/api/cameras/add',
            remove: '/api/cameras/remove',
            activate: '/api/cameras/activate'
        },
        emotion: {
            models: '/api/emotion/models',
            modelInfo: '/api/emotion/model',
            switchModel: '/api/emotion/switch_model',
            testAudio: '/api/emotion/test_audio',
            restartAudio: '/api/emotion/restart_audio'
        },
        audio: {
            microphones: '/api/audio/microphones',
            setMicrophone: '/api/audio/set_microphone'
        },
        system: {
            check: '/api/system/check',
            info: '/api/system/info',
            restart: '/api/system/restart',
            stop: '/api/system/stop'
        }
    };
}

// Initialize the page
let socket = io();
let currentModelId = null;
let currentMicrophoneId = null;

// Initialize when document is ready
document.addEventListener('DOMContentLoaded', function() {
    // First system check with a delay to ensure server is ready
    setTimeout(checkSystem, 1000);
    
    // Initialize model select
    fetchAvailableModels();
    
    // Initialize microphone select
    fetchAvailableMicrophones();
    
    // Request initial camera list
    fetchCameras();
    
    // Initialize camera type inputs
    toggleCameraInput();
    
    // Log initialization
    {% if mode == "normal" %}
    addLogEntry('info', 'Baby Monitor system starting up');
    {% else %}
    addLogEntry('info', 'System initialization started');
    {% endif %}
});

// Socket connection handlers
socket.on('connect', () => {
    addLogEntry('success', 'Connected to server');
    // Request initial system status on connect
    checkSystem();
});

socket.on('disconnect', () => {
    addLogEntry('error', 'Disconnected from server');
    updateSystemStatus({
        camera: { status: 'error', message: 'Server disconnected' },
        audio: { status: 'error', message: 'Server disconnected' },
        detection: { status: 'error', message: 'Server disconnected' },
        emotion: { status: 'error', message: 'Server disconnected' }
    });
});

socket.on('camera_status', (data) => {
    updateCameraStatus(data);
});

socket.on('system_status', (data) => {
    updateSystemStatus(data);
});

socket.on('emotion_model_changed', (data) => {
    if (data && data.name) {
        addLogEntry('info', `Switched to model: ${data.name}`);
        updateModelInfo(data);
        // Update model select if it exists
        const modelSelect = document.getElementById('modelSelect');
        if (modelSelect) {
            Array.from(modelSelect.options).forEach(option => {
                if (option.textContent.includes(data.name)) {
                    option.selected = true;
                    currentModelId = option.value;
                }
            });
        }
    }
});

socket.on('microphone_changed', (data) => {
    addLogEntry('info', `Switched to microphone: ${data.name}`);
    updateMicrophoneInfo(data);
});

socket.on('camera_added', (data) => {
    addLogEntry('success', `Camera added: ${data.name}`);
    fetchCameras();
});

socket.on('camera_removed', (data) => {
    addLogEntry('info', `Camera removed: ${data.id}`);
    fetchCameras();
});

socket.on('camera_activated', (data) => {
    addLogEntry('info', `Camera activated: ${data.id}`);
    fetchCameras();
});

// Fetch available cameras
function fetchCameras() {
    fetch(API.cameras.list)
        .then(response => {
            if (!response.ok) {
                throw new Error(`Failed to fetch cameras: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            updateCameraList(data.cameras || []);
        })
        .catch(error => {
            console.error('Error fetching cameras:', error);
            addLogEntry('error', `Error fetching cameras: ${error.message}`);
        });
}

// Update camera list display
function updateCameraList(cameras) {
    const cameraList = document.getElementById('cameraList');
    if (!cameraList) return;
    
    cameraList.innerHTML = '';
    
    if (cameras && cameras.length > 0) {
        cameras.forEach(camera => {
            const isActive = camera.active ? 'active bg-primary text-white' : '';
            const item = document.createElement('div');
            item.className = `list-group-item list-group-item-action d-flex justify-content-between align-items-center ${isActive}`;
            item.innerHTML = `
                <div>
                    <h6 class="mb-0">${camera.name}</h6>
                    <small class="text-muted">${camera.resolution || 'Default resolution'}</small>
                </div>
                <div>
                    ${camera.active ? 
                        `<span class="badge bg-success me-2">Active</span>` :
                        `<button class="btn btn-sm btn-success me-2" onclick="activateCamera('${camera.id}')">
                            <i class="bi bi-play-fill"></i>
                        </button>`
                    }
                    <button class="btn btn-sm btn-danger" onclick="removeCamera('${camera.id}')">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            `;
            cameraList.appendChild(item);
        });
    } else {
        cameraList.innerHTML = `
            <div class="list-group-item text-center text-muted">
                No cameras connected
            </div>
        `;
    }
}

// Add camera function
function addCamera() {
    const cameraName = document.getElementById('cameraName').value.trim();
    const cameraType = document.getElementById('cameraType').value;
    let cameraUrl;
    
    if (cameraType === 'webcam') {
        cameraUrl = document.getElementById('cameraUrl').value.trim();
    } else {
        cameraUrl = document.getElementById('ipCameraUrl').value.trim();
    }
    
    if (!cameraName) {
        addLogEntry('warning', 'Please enter a camera name');
            return;
        }
        
    if (!cameraUrl) {
        addLogEntry('warning', 'Please enter a device ID or URL');
            return;
        }
        
    addLogEntry('info', `Adding camera: ${cameraName}`);
    
    fetch(API.cameras.add, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
        body: JSON.stringify({
            name: cameraName,
            device: cameraUrl
        })
    })
    .then(response => {
            if (!response.ok) {
            return response.json().then(data => {
                throw new Error(data.message || `Server error: ${response.status}`);
            });
        }
        return response.json();
    })
    .then(data => {
        addLogEntry('success', data.message || 'Camera added successfully');
        // Clear inputs
        document.getElementById('cameraName').value = '';
        if (cameraType === 'ip') {
            document.getElementById('ipCameraUrl').value = '';
        }
        // Refresh camera list
        fetchCameras();
    })
    .catch(error => {
        console.error('Error adding camera:', error);
        addLogEntry('error', `Error adding camera: ${error.message}`);
    });
}

// Toggle camera input fields based on camera type
function toggleCameraInput() {
    const cameraType = document.getElementById('cameraType').value;
    const webcamSection = document.getElementById('webcamSection');
    const ipCameraSection = document.getElementById('ipCameraSection');
    
    if (cameraType === 'webcam') {
        webcamSection.style.display = 'block';
        ipCameraSection.style.display = 'none';
                } else {
        webcamSection.style.display = 'none';
        ipCameraSection.style.display = 'block';
    }
}

// Remove camera function
function removeCamera(cameraId) {
    if (!confirm(`Are you sure you want to remove this camera?`)) {
        return;
    }
    
    addLogEntry('info', `Removing camera: ${cameraId}`);
    
    fetch(API.cameras.remove, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            camera_id: cameraId
        })
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(data => {
                throw new Error(data.message || `Server error: ${response.status}`);
            });
        }
        return response.json();
    })
    .then(data => {
        addLogEntry('success', data.message || 'Camera removed successfully');
        // Refresh camera list
        fetchCameras();
    })
    .catch(error => {
        console.error('Error removing camera:', error);
        addLogEntry('error', `Error removing camera: ${error.message}`);
    });
}

// Activate camera function
function activateCamera(cameraId) {
    addLogEntry('info', `Activating camera: ${cameraId}`);
    
    fetch(API.cameras.activate, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            camera_id: cameraId
        })
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(data => {
                throw new Error(data.message || `Server error: ${response.status}`);
            });
        }
        return response.json();
    })
    .then(data => {
        addLogEntry('success', data.message || 'Camera activated successfully');
        // Refresh camera list
        fetchCameras();
    })
    .catch(error => {
        console.error('Error activating camera:', error);
        addLogEntry('error', `Error activating camera: ${error.message}`);
    });
}

// Fetch available emotion models
function fetchAvailableModels() {
    addLogEntry('info', 'Loading emotion models...');
    
    fetch(API.emotion.models)
        .then(response => {
            if (!response.ok) {
                throw new Error(`Failed to fetch models: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            populateModelSelect(data);
            addLogEntry('success', 'Successfully loaded emotion models');
        })
        .catch(error => {
            console.error('Error fetching models:', error);
            addLogEntry('error', `Error loading emotion models: ${error.message}`);
            
            // Update model info to show error
            const modelInfo = document.getElementById('modelInfo');
            if (modelInfo) {
                modelInfo.innerHTML = `
                    <div class="alert alert-danger">
                        <h6 class="alert-heading"><i class="bi bi-exclamation-triangle"></i> Error Loading Models</h6>
                        <p class="mb-0">Please check if the model files are installed correctly in the models directory.</p>
        </div>
    `;
}
        });
}

// Populate model select dropdown
function populateModelSelect(data) {
    const modelSelect = document.getElementById('modelSelect');
    if (!modelSelect) return;
    
    // Clear existing options
    modelSelect.innerHTML = '<option value="">Select a model...</option>';
    
    // Add options for each available model
    if (data.models && Array.isArray(data.models)) {
        data.models.forEach(model => {
            const option = document.createElement('option');
            option.value = model.id;
            option.textContent = `${model.name} (${model.type})`;
            if (!model.is_available) {
                option.disabled = true;
                option.textContent += ' - Not Available';
            }
            if (data.current_model && data.current_model.id === model.id) {
                option.selected = true;
                currentModelId = model.id;
                updateModelInfo(data.current_model);
            }
            modelSelect.appendChild(option);
        });
    }
}

// Update model info display
function updateModelInfo(model) {
    const modelInfoDiv = document.getElementById('modelInfo');
    if (!modelInfoDiv) return;
    
    const emotions = model.emotions ? model.emotions.join(', ') : 'Unknown';
    const modelTypeClass = getModelTypeClass(model.type);
    
    modelInfoDiv.innerHTML = `
        <div class="card bg-dark">
            <div class="card-body">
                <h6 class="card-subtitle mb-2 text-info">${model.name}</h6>
                <p class="card-text">
                    <small class="text-muted">Type: <span class="badge ${modelTypeClass}">${model.type}</span></small><br>
                    <small class="text-muted">Supported Emotions: ${emotions}</small>
                </p>
            </div>
                </div>
            `;
        }

// Get appropriate badge class for model type
function getModelTypeClass(type) {
    if (!type) return 'bg-secondary';
    
    switch(type.toLowerCase()) {
        case 'advanced': return 'bg-success';
        case 'basic': return 'bg-primary';
        case 'binary': return 'bg-warning';
        case 'speechbrain': return 'bg-info';
        default: return 'bg-secondary';
    }
}

// Fetch available microphones
function fetchAvailableMicrophones() {
    addLogEntry('info', 'Loading available microphones...');
    
    // Clear microphone select and show loading state
    const microphoneSelect = document.getElementById('microphoneSelect');
    if (microphoneSelect) {
        microphoneSelect.innerHTML = '<option value="">Loading microphones...</option>';
        microphoneSelect.disabled = true;
    }
    
    // Update microphone info to show loading
    const microphoneInfo = document.getElementById('microphoneInfo');
    if (microphoneInfo) {
        microphoneInfo.innerHTML = '<small class="text-muted"><i class="bi bi-hourglass-split"></i> Detecting microphones...</small>';
    }
    
    fetch(API.audio.microphones)
        .then(response => {
            if (!response.ok) {
                throw new Error(`Failed to fetch microphones: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            populateMicrophoneSelect(data);
            addLogEntry('success', 'Successfully loaded microphone list');
            
            // Enable the select
            if (microphoneSelect) {
                microphoneSelect.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error fetching microphones:', error);
            addLogEntry('error', `Error loading microphones: ${error.message}`);
            
            // Update microphone info to show error
            const microphoneInfo = document.getElementById('microphoneInfo');
            if (microphoneInfo) {
                microphoneInfo.innerHTML = `
                    <div class="alert alert-danger">
                        <h6 class="alert-heading"><i class="bi bi-exclamation-triangle"></i> Error Loading Microphones</h6>
                        <p class="mb-0">Could not load available microphones. Please check audio drivers and system permissions.</p>
                    </div>
                `;
            }
            
            // Enable the select but show error option
            if (microphoneSelect) {
                microphoneSelect.innerHTML = '<option value="">Error loading microphones</option>';
                microphoneSelect.disabled = false;
            }
        });
}

// Populate microphone select dropdown
function populateMicrophoneSelect(data) {
    const microphoneSelect = document.getElementById('microphoneSelect');
    if (!microphoneSelect) return;
    
    // Clear existing options
    microphoneSelect.innerHTML = '<option value="">Select a microphone...</option>';
    
    // Add options for each available microphone
    if (data.microphones && Array.isArray(data.microphones)) {
        data.microphones.forEach(mic => {
            const option = document.createElement('option');
            option.value = mic.id;
            option.textContent = mic.name;
            
            if (!mic.is_available) {
                option.disabled = true;
                option.textContent += ' - Not Available';
            }
            
            if (data.current_microphone && data.current_microphone.id === mic.id) {
                option.selected = true;
                currentMicrophoneId = mic.id;
                
                // Update microphone info
                updateMicrophoneInfo(mic);
            }
            
            microphoneSelect.appendChild(option);
        });
    }
}

// Update microphone info display
function updateMicrophoneInfo(microphone) {
    const microphoneInfoDiv = document.getElementById('microphoneInfo');
    if (!microphoneInfoDiv) return;
    
    let qualityBadge = '';
    if (microphone.quality) {
        let badgeClass = 'bg-secondary';
        switch(microphone.quality.toLowerCase()) {
            case 'high': badgeClass = 'bg-success'; break;
            case 'medium': badgeClass = 'bg-info'; break;
            case 'low': badgeClass = 'bg-warning'; break;
            default: badgeClass = 'bg-secondary';
        }
        qualityBadge = `<span class="badge ${badgeClass} ms-2">${microphone.quality}</span>`;
    }
    
    microphoneInfoDiv.innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
            <small class="text-muted">Device: ${microphone.name}</small>
            ${qualityBadge}
        </div>
        <small class="text-muted d-block">Sample Rate: ${microphone.sample_rate || 'Default'}</small>
    `;
}

// Apply microphone selection function
function applyMicrophoneSelection() {
    const microphoneSelect = document.getElementById('microphoneSelect');
    const selectedMicrophone = microphoneSelect?.value;
    
    if (!selectedMicrophone) {
        addLogEntry('warning', 'Please select a microphone first');
        return;
    }
    
    // Disable the button and microphone select during application
    const applyButton = document.querySelector('button[onclick="applyMicrophoneSelection()"]');
    if (applyButton) {
        applyButton.disabled = true;
        applyButton.innerHTML = '<i class="bi bi-hourglass-split"></i> Applying...';
    }
    if (microphoneSelect) {
        microphoneSelect.disabled = true;
    }
    
    addLogEntry('info', `Applying microphone selection: ${selectedMicrophone}...`);
    
    fetch(API.audio.setMicrophone, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ microphone_id: selectedMicrophone })
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(data => {
                throw new Error(data.message || `Server error: ${response.status}`);
            });
        }
        return response.json();
    })
    .then(data => {
        addLogEntry('success', data.message || 'Microphone applied successfully');
        
        if (data.microphone_info) {
            updateMicrophoneInfo(data.microphone_info);
            currentMicrophoneId = selectedMicrophone;
        }
        
        // Re-enable controls
        if (applyButton) {
            applyButton.disabled = false;
            applyButton.innerHTML = '<i class="bi bi-mic"></i> Apply Microphone Selection';
        }
        if (microphoneSelect) {
            microphoneSelect.disabled = false;
        }
        
        // Test the microphone after applying
        setTimeout(() => {
            testAudio();
        }, 1000);
    })
    .catch(error => {
        console.error('Error applying microphone:', error);
        addLogEntry('error', `Error applying microphone: ${error.message}`);
        
        // Re-enable controls
        if (applyButton) {
            applyButton.disabled = false;
            applyButton.innerHTML = '<i class="bi bi-mic"></i> Apply Microphone Selection';
        }
        if (microphoneSelect) {
            microphoneSelect.disabled = false;
        }
    });
}

// Handle microphone selection change
document.addEventListener('DOMContentLoaded', function() {
    const microphoneSelect = document.getElementById('microphoneSelect');
    if (microphoneSelect) {
        microphoneSelect.addEventListener('change', function() {
            const selectedMicrophoneId = this.value;
            if (!selectedMicrophoneId) return;
            
            fetch(`${API.audio.microphones}/${selectedMicrophoneId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Failed to fetch microphone info: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.microphone_info) {
                        updateMicrophoneInfo(data.microphone_info);
                    }
                })
                .catch(error => {
                    console.error('Error fetching microphone info:', error);
                    addLogEntry('error', `Error fetching microphone info: ${error.message}`);
                });
        });
    }
});

// Also update the applyEmotionModel function to apply microphone selection too
function applyEmotionModel() {
    const modelSelect = document.getElementById('modelSelect');
    const selectedModel = modelSelect?.value;
    
    if (!selectedModel) {
        addLogEntry('warning', 'Please select a model first');
        return;
    }
    
    // Disable the select and button during the change
    modelSelect.disabled = true;
    const applyButton = document.querySelector('button[onclick="applyEmotionModel()"]');
    if (applyButton) {
        applyButton.disabled = true;
        applyButton.innerHTML = '<i class="bi bi-hourglass-split"></i> Applying...';
    }
    
    addLogEntry('info', `Applying model: ${selectedModel}...`);
    
    fetch(API.emotion.switchModel, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ model_id: selectedModel })
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(data => {
                throw new Error(data.message || `Server error: ${response.status}`);
            });
        }
        return response.json();
    })
    .then(data => {
        addLogEntry('success', data.message || 'Model applied successfully');
        
        if (data.model_info) {
            updateModelInfo(data.model_info);
            currentModelId = selectedModel;
        }
    })
    .catch(error => {
        console.error('Error applying model:', error);
        addLogEntry('error', `Error applying model: ${error.message}`);
    })
    .finally(() => {
        // Re-enable controls
        modelSelect.disabled = false;
        if (applyButton) {
            applyButton.disabled = false;
            applyButton.innerHTML = '<i class="bi bi-check2-circle"></i> Apply Model';
        }
    });
}

// Handle model selection change
document.addEventListener('DOMContentLoaded', function() {
    const modelSelect = document.getElementById('modelSelect');
    if (modelSelect) {
        modelSelect.addEventListener('change', function() {
            const selectedModelId = this.value;
            if (!selectedModelId) return;
            
            fetch(`${API.emotion.modelInfo}/${selectedModelId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Failed to fetch model info: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.model_info) {
                        updateModelInfo(data.model_info);
                    }
                })
                .catch(error => {
                    console.error('Error fetching model info:', error);
                    addLogEntry('error', `Error fetching model info: ${error.message}`);
                });
        });
    }
});

// Test audio function
function testAudio() {
    addLogEntry('info', 'Testing audio system...');
    
    // Disable the button during test
    const testButton = document.querySelector('button[onclick="testAudio()"]');
    if (testButton) {
        testButton.disabled = true;
        testButton.innerHTML = '<i class="bi bi-mic"></i> Testing...';
    }
    
    fetch(API.emotion.testAudio, {
        method: 'POST'
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(data => {
                throw new Error(data.message || `Server error: ${response.status}`);
            });
        }
        return response.json();
    })
    .then(data => {
        // Check if test was successful
        if (data.success === false) {
            addLogEntry('warning', data.message || 'Audio test completed with warnings');
            
            // Show a detailed message with what went wrong
            const microphoneInfo = document.getElementById('microphoneInfo');
            if (microphoneInfo) {
                microphoneInfo.innerHTML = `
                    <div class="alert alert-warning">
                        <h6 class="alert-heading"><i class="bi bi-exclamation-triangle"></i> Audio Test Warning</h6>
                        <p class="mb-0">${data.message || 'Could not detect audio properly. Please check your microphone.'}</p>
                    </div>
                `;
            }
        } else {
            addLogEntry('success', data.message || 'Audio test initiated successfully');
            
            // If we have test results, display them
            if (data.results) {
                const results = data.results;
                const microphoneInfo = document.getElementById('microphoneInfo');
                if (microphoneInfo && results.signal_detected) {
                    const signalStrength = Math.round(results.signal_strength * 100);
                    const noiseLevel = Math.round(results.background_noise * 100);
                    
                    microphoneInfo.innerHTML += `
                        <div class="mt-2 p-2 bg-dark rounded">
                            <div class="d-flex justify-content-between mb-1">
                                <small class="text-muted">Signal Strength:</small>
                                <small class="${signalStrength > 50 ? 'text-success' : 'text-warning'}">${signalStrength}%</small>
                            </div>
                            <div class="progress bg-secondary mb-2" style="height: 5px;">
                                <div class="progress-bar ${signalStrength > 50 ? 'bg-success' : 'bg-warning'}" 
                                     style="width: ${signalStrength}%"></div>
                            </div>
                            
                            <div class="d-flex justify-content-between mb-1">
                                <small class="text-muted">Background Noise:</small>
                                <small class="${noiseLevel < 30 ? 'text-success' : 'text-warning'}">${noiseLevel}%</small>
                            </div>
                            <div class="progress bg-secondary" style="height: 5px;">
                                <div class="progress-bar ${noiseLevel < 30 ? 'bg-success' : 'bg-warning'}" 
                                     style="width: ${noiseLevel}%"></div>
                            </div>
                        </div>
                    `;
                }
            }
        }
        
        // Re-enable the button
        if (testButton) {
            testButton.disabled = false;
            testButton.innerHTML = '<i class="bi bi-play-circle"></i> Test Audio';
        }
    })
    .catch(error => {
        console.error('Error testing audio:', error);
        addLogEntry('error', `Error testing audio: ${error.message}`);
        
        // Re-enable the button
        if (testButton) {
            testButton.disabled = false;
            testButton.innerHTML = '<i class="bi bi-play-circle"></i> Test Audio';
        }
    });
}

// Restart audio function
function restartAudio() {
    addLogEntry('info', 'Restarting audio system...');
    
    fetch(API.emotion.restartAudio, {
        method: 'POST'
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(data => {
                throw new Error(data.message || `Server error: ${response.status}`);
            });
        }
        return response.json();
    })
    .then(data => {
        addLogEntry('success', data.message || 'Audio system restarted successfully');
    })
    .catch(error => {
        console.error('Error restarting audio:', error);
        addLogEntry('error', `Error restarting audio: ${error.message}`);
    });
}

        // Check system status
function checkSystem() {
    {% if mode == "normal" %}
    addLogEntry('info', 'Checking baby monitor status...');
    {% else %}
    addLogEntry('info', 'Checking system status...');
    {% endif %}
    
    fetch(API.system.check)
        .then(response => {
            if (!response.ok) {
                throw new Error(`Failed to check system: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            updateSystemStatus(data);
            {% if mode == "normal" %}
            addLogEntry('success', 'Baby monitor check completed');
            {% else %}
            addLogEntry('success', 'System check completed');
            {% endif %}
            
            // Also get system info
            return fetch(API.system.info);
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Failed to get system info: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            updateSystemInfo(data);
        })
        .catch(error => {
            console.error('Error checking system:', error);
            {% if mode == "normal" %}
            addLogEntry('error', `Problem checking baby monitor: ${error.message}`);
            {% else %}
            addLogEntry('error', `Error checking system: ${error.message}`);
            {% endif %}
        });
}

// System restart function
function restartSystem() {
    {% if mode == "normal" %}
    if (!confirm('Are you sure you want to restart the baby monitor?')) return;
    
    addLogEntry('info', 'Restarting baby monitor...');
    {% else %}
    if (!confirm('Are you sure you want to restart the system?')) return;
    
    addLogEntry('info', 'Restarting system...');
    {% endif %}
    
    fetch(API.system.restart, {
        method: 'POST'
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(data => {
                throw new Error(data.message || `Server error: ${response.status}`);
            });
        }
        return response.json();
    })
    .then(data => {
        {% if mode == "normal" %}
        addLogEntry('success', data.message || 'Baby monitor restarted successfully');
        {% else %}
        addLogEntry('success', data.message || 'System restarted successfully');
        {% endif %}
        // Check system status after a short delay
        setTimeout(checkSystem, 2000);
    })
    .catch(error => {
        console.error('Error restarting system:', error);
        {% if mode == "normal" %}
        addLogEntry('error', `Problem restarting baby monitor: ${error.message}`);
        {% else %}
        addLogEntry('error', `Error restarting system: ${error.message}`);
        {% endif %}
    });
}

// System stop function
function stopSystem() {
    {% if mode == "normal" %}
    if (!confirm('Are you sure you want to stop the baby monitor?')) return;
    
    addLogEntry('info', 'Stopping baby monitor...');
    {% else %}
    if (!confirm('Are you sure you want to stop the system?')) return;
    
    addLogEntry('info', 'Stopping system...');
    {% endif %}
    
    fetch(API.system.stop, {
        method: 'POST'
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(data => {
                throw new Error(data.message || `Server error: ${response.status}`);
            });
        }
        return response.json();
    })
    .then(data => {
        {% if mode == "normal" %}
        addLogEntry('success', data.message || 'Baby monitor stopped successfully');
        {% else %}
        addLogEntry('success', data.message || 'System stopped successfully');
        {% endif %}
        updateSystemStatus({
            camera: { status: 'error', message: 'System stopped' },
            audio: { status: 'error', message: 'System stopped' },
            detection: { status: 'error', message: 'System stopped' },
            emotion: { status: 'error', message: 'System stopped' }
        });
    })
    .catch(error => {
        console.error('Error stopping system:', error);
        {% if mode == "normal" %}
        addLogEntry('error', `Problem stopping baby monitor: ${error.message}`);
        {% else %}
        addLogEntry('error', `Error stopping system: ${error.message}`);
        {% endif %}
    });
}

// Update system status
function updateSystemStatus(data) {
    // Update status badges
    updateStatusBadge('cameraSystemStatus', data.camera?.status, data.camera?.message);
    updateStatusBadge('audioSystemStatus', data.audio?.status, data.audio?.message);
    updateStatusBadge('personDetectionStatus', data.detection?.status, data.detection?.message);
    updateStatusBadge('emotionDetectionStatus', data.emotion?.status, data.emotion?.message);
    
    // Add log entries for any warnings or errors
    Object.entries(data).forEach(([system, info]) => {
        if (info.status === 'warning') {
            addLogEntry('warning', `${system}: ${info.message}`);
        } else if (info.status === 'error') {
            addLogEntry('error', `${system}: ${info.message}`);
        }
    });
}

// Update status badge
function updateStatusBadge(elementId, status, message) {
    const badge = document.getElementById(elementId);
    if (!badge) return;
    
    badge.className = `badge ${getStatusClass(status)}`;
    badge.textContent = status?.toUpperCase() || 'UNKNOWN';
    badge.title = message || status || 'Unknown';
}

// Get status badge class
function getStatusClass(status) {
    if (!status) return 'bg-secondary';
    
    switch(status.toLowerCase()) {
        case 'ok':
            return 'bg-success';
        case 'warning':
            return 'bg-warning text-dark';
        case 'error':
            return 'bg-danger';
        default:
            return 'bg-secondary';
    }
}

// Update system info
function updateSystemInfo(data) {
    const systemInfo = document.getElementById('systemInfo');
    if (!systemInfo) return;
    
    // Create a table to display system information
    const table = document.createElement('table');
    table.className = 'table table-sm table-dark';
    
    // System Status
    let html = `
        <tr>
            <th colspan="2" class="table-info">System Status</th>
        </tr>
        <tr>
            <td>CPU Usage:</td>
            <td>${data.cpu_usage?.toFixed(1) || 0}%</td>
        </tr>
        <tr>
            <td>Memory Usage:</td>
            <td>${data.memory_usage?.toFixed(1) || 0}% (${data.memory_available || 0} MB available)</td>
        </tr>
        <tr>
            <td>Disk Usage:</td>
            <td>${data.disk_usage?.toFixed(1) || 0}%</td>
        </tr>
        <tr>
            <td>Uptime:</td>
            <td>${data.uptime || '00:00:00'}</td>
        </tr>
    `;
        
    // System Information
    if (data.system_info) {
        html += `
        <tr>
            <th colspan="2" class="table-info">System Information</th>
        </tr>
        <tr>
            <td>Operating System:</td>
                <td>${data.system_info.os || 'Unknown'}</td>
        </tr>
        <tr>
            <td>Python Version:</td>
                <td>${data.system_info.python_version || 'Unknown'}</td>
        </tr>
        <tr>
            <td>OpenCV Version:</td>
                <td>${data.system_info.opencv_version || 'Unknown'}</td>
        </tr>
        `;
    }
        
    // Camera Configuration
    if (data.system_info) {
        html += `
        <tr>
            <th colspan="2" class="table-info">Camera Configuration</th>
        </tr>
        <tr>
            <td>Resolution:</td>
                <td>${data.system_info.camera_resolution || 'Unknown'}</td>
        </tr>
        <tr>
            <td>Camera Device:</td>
                <td>${data.system_info.camera_device || 'Unknown'}</td>
        </tr>
        `;
    }
        
    // Audio Configuration
    if (data.system_info) {
        html += `
        <tr>
            <th colspan="2" class="table-info">Audio Configuration</th>
        </tr>
        <tr>
            <td>Microphone Device:</td>
            <td>${data.system_info.microphone_device || 'Unknown'}</td>
        </tr>
        <tr>
            <td>Device Index:</td>
            <td>${data.system_info.microphone_index !== undefined ? data.system_info.microphone_index : 'Default'}</td>
        </tr>
        <tr>
            <td>Sample Rate:</td>
            <td>${data.system_info.audio_sample_rate || 'Unknown'} Hz</td>
        </tr>
        <tr>
            <td>Channels:</td>
            <td>${data.system_info.audio_channels || 'Unknown'}</td>
        </tr>
        <tr>
            <td>Bit Depth:</td>
            <td>${data.system_info.audio_bit_depth || 'Default'} bit</td>
        </tr>
        <tr>
            <td>Input Gain:</td>
            <td>${data.system_info.audio_gain !== undefined ? data.system_info.audio_gain + ' dB' : 'Default'}</td>
        </tr>
        `;
    }
        
    // Emotion Model
    if (data.model_info) {
        html += `
        <tr>
            <th colspan="2" class="table-info">Emotion Model</th>
        </tr>
        <tr>
            <td>Current Model:</td>
                <td>${data.model_info.name || 'Unknown'} (${data.model_info.type || 'Unknown'})</td>
        </tr>
        <tr>
            <td>Supported Emotions:</td>
                <td>${data.model_info.emotions?.join(', ') || 'Unknown'}</td>
        </tr>
    `;
    }
    
    table.innerHTML = html;
    systemInfo.innerHTML = '';
    systemInfo.appendChild(table);
}

// Add log entry
function addLogEntry(type, message, error = null) {
    const log = document.getElementById('statusLog');
    if (!log) return;
    
    const time = new Date().toLocaleTimeString();
    const entry = document.createElement('div');
    entry.className = `log-entry ${type}`;
    
    let errorDetails = '';
    if (error) {
        errorDetails = `
            <div class="error-details collapse" id="error-${Date.now()}"
                <div class="card card-body bg-dark mt-2">
                    <pre class="text-danger mb-0"><code>${error.stack || error.message || JSON.stringify(error, null, 2)}</code></pre>
                </div>
            </div>
        `;
    }
    
    entry.innerHTML = `
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <span class="log-time">${time}</span>
                <span class="log-message">${message}</span>
            </div>
            ${error ? `
                <button class="btn btn-sm btn-outline-info ms-2" 
                        data-bs-toggle="collapse" 
                        data-bs-target="#error-${Date.now()}"
                        aria-expanded="false">
                    <i class="bi bi-chevron-down"></i>
                </button>
            ` : ''}
        </div>
        ${errorDetails}
    `;
    
    log.insertBefore(entry, log.firstChild);
}

// Clear log
function clearLog() {
    if (!confirm('Are you sure you want to clear the log?')) return;
    
    const log = document.getElementById('statusLog');
    if (log) {
        log.innerHTML = '';
    addLogEntry('info', 'Log cleared');
    }
}

// Desktop app functions
function launchDesktopApp() {
    addLogEntry('info', 'Launching desktop application...');
    // Add your desktop app launch logic here
}

function checkInstallation() {
    addLogEntry('info', 'Checking installation...');
    const status = document.getElementById('installStatus');
    status.innerHTML = `
        <div class="alert alert-info mt-3">
            <h6><i class="bi bi-info-circle"></i> Installation Status</h6>
            <ul class="mb-0">
                <li>Python Version: 3.8.10 (OK)</li>
                <li>Required Packages: Installed (OK)</li>
                <li>Model Files: Present (OK)</li>
                <li>Configuration: Valid (OK)</li>
            </ul>
        </div>
    `;
}

// Update camera status function
function updateCameraStatus(data) {
    const cameraSystemStatus = document.getElementById('cameraSystemStatus');
    if (!cameraSystemStatus) return;

    if (data.connected) {
        cameraSystemStatus.className = 'badge bg-success';
        cameraSystemStatus.textContent = 'CONNECTED';
        cameraSystemStatus.title = 'Camera is working properly';
    } else if (data.connecting) {
        cameraSystemStatus.className = 'badge bg-warning text-dark';
        cameraSystemStatus.textContent = 'CONNECTING';
        cameraSystemStatus.title = 'Attempting to connect to camera';
    } else {
        cameraSystemStatus.className = 'badge bg-danger';
        cameraSystemStatus.textContent = 'DISCONNECTED';
        cameraSystemStatus.title = data.error || 'Camera is not connected';
    }
}
</script>
{% endblock %} 