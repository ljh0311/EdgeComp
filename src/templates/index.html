<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Baby Monitor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      body {
        background-color: #1a1a1a;
        color: #ffffff;
      }
      
      .video-container {
        position: relative;
        width: 100%;
        background-color: #000;
        aspect-ratio: 16/9;
        border-radius: 10px;
        overflow: hidden;
      }
      
      #videoFeed {
        width: 100%;
        height: 100%;
        object-fit: contain;
      }
      
      .controls {
        background-color: #2d2d2d;
        border-radius: 10px;
        padding: 20px;
        margin-top: 20px;
      }
      
      .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
      }
      
      .status-active {
        background-color: #28a745;
      }
      
      .status-inactive {
        background-color: #dc3545;
      }
      
      .alert-container {
        max-height: 300px;
        overflow-y: auto;
      }
      
      .alert-item {
        padding: 10px;
        margin: 5px 0;
        border-radius: 5px;
        background-color: #2d2d2d;
      }
      
      .alert-critical {
        border-left: 4px solid #dc3545;
      }
      
      .alert-warning {
        border-left: 4px solid #ffc107;
      }
      
      .alert-info {
        border-left: 4px solid #17a2b8;
      }
    </style>
  </head>
  <body>
    <div class="container-fluid py-4">
      <div class="row">
        <div class="col-lg-8">
          <!-- Video Feed -->
          <div class="video-container">
            <img id="videoFeed" src="" alt="Video Feed">
          </div>
          
          <!-- Controls -->
          <div class="controls">
            <div class="row">
              <div class="col-md-6">
                <h5>Controls</h5>
                <button id="toggleCamera" class="btn btn-primary me-2">Toggle Camera</button>
                <button id="toggleAudio" class="btn btn-primary">Toggle Audio</button>
              </div>
              <div class="col-md-6">
                <h5>Status</h5>
                <div class="mb-2">
                  <span class="status-indicator" id="cameraStatus"></span>
                  Camera
                </div>
                <div class="mb-2">
                  <span class="status-indicator" id="audioStatus"></span>
                  Audio
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-lg-4">
          <!-- Alerts -->
          <div class="controls">
            <h5>Alerts</h5>
            <div id="alertContainer" class="alert-container">
              <!-- Alerts will be added here -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const socket = io();
      let alertCount = 0;
      const maxAlerts = 50;

      // Update video feed
      socket.on('frame', function(data) {
        document.getElementById('videoFeed').src = 'data:image/jpeg;base64,' + data.frame;
      });

      // Handle alerts
      socket.on('alert', function(data) {
        const alertContainer = document.getElementById('alertContainer');
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert-item alert-${data.type}`;
        alertDiv.innerHTML = `
          <small class="text-muted">${data.timestamp}</small>
          <div>${data.message}</div>
        `;
        alertContainer.insertBefore(alertDiv, alertContainer.firstChild);
        
        // Limit number of alerts
        alertCount++;
        if (alertCount > maxAlerts) {
          alertContainer.removeChild(alertContainer.lastChild);
          alertCount--;
        }
      });

      // Handle status updates
      socket.on('status', function(data) {
        if (data.type === 'status') {
          updateStatus(data.data);
        }
      });

      // Update status indicators
      function updateStatus(status) {
        document.getElementById('cameraStatus').className = 
          'status-indicator ' + (status.camera_enabled ? 'status-active' : 'status-inactive');
        document.getElementById('audioStatus').className = 
          'status-indicator ' + (status.audio_enabled ? 'status-active' : 'status-inactive');
      }

      // Control buttons
      document.getElementById('toggleCamera').addEventListener('click', function() {
        fetch('/control/toggle_camera', { method: 'POST' })
          .then(response => response.json())
          .then(data => {
            if (data.status === 'success') {
              updateStatus({ camera_enabled: data.camera_enabled });
            }
          });
      });

      document.getElementById('toggleAudio').addEventListener('click', function() {
        fetch('/control/toggle_audio', { method: 'POST' })
          .then(response => response.json())
          .then(data => {
            if (data.status === 'success') {
              updateStatus({ audio_enabled: data.audio_enabled });
            }
          });
      });

      // Initial status check
      fetch('/status')
        .then(response => response.json())
        .then(data => {
          if (!data.error) {
            updateStatus(data);
          }
        });
    </script>
  </body>
</html>
