<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baby Monitor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #1a1a1a;
            color: #ffffff;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }
        
        .video-section {
            background: #2d2d2d;
            padding: 20px;
            border-radius: 10px;
        }
        
        .info-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .status-panel, .detection-panel, .alerts-panel {
            background: #2d2d2d;
            padding: 20px;
            border-radius: 10px;
        }
        
        .video-container {
            position: relative;
            width: 100%;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        #videoFeed {
            width: 100%;
            height: auto;
            display: block;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .control-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #444;
            background: #333;
            color: white;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            background: #007bff;
            color: white;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        button:disabled {
            background: #444;
            cursor: not-allowed;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .status-item {
            background: #333;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .status-icon {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .status-icon.active {
            color: #28a745;
        }
        
        .status-icon.inactive {
            color: #dc3545;
        }
        
        .detection-info {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .detection-item {
            background: #333;
            padding: 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .alerts-list {
            max-height: 300px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .alert-item {
            background: #333;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid;
        }
        
        .alert-item.critical {
            border-color: #dc3545;
        }
        
        .alert-item.warning {
            border-color: #ffc107;
        }
        
        .alert-item.info {
            border-color: #17a2b8;
        }
        
        .alert-time {
            font-size: 0.8em;
            color: #888;
        }
        
        #waveform {
            width: 100%;
            height: 60px;
            background: #333;
            border-radius: 4px;
            margin-top: 10px;
        }
        
        .placeholder {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: white;
            display: none;
        }
        
        #errorMessage {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #dc3545;
            color: white;
            padding: 15px;
            border-radius: 8px;
            display: none;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-content">
            <div class="video-section">
                <div class="video-container">
                    <img id="videoFeed" src="" alt="Video Feed">
                    <div class="placeholder" id="cameraPlaceholder">
                        <i class="fas fa-video-slash"></i>
                        <p>Camera is disabled</p>
                    </div>
                </div>
                
                <div class="controls">
                    <div class="control-group">
                        <select id="cameraSelect">
                            <option value="">Select Camera</option>
                        </select>
                        <select id="resolutionSelect">
                            <option value="">Select Resolution</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <button id="toggleCamera">
                            <i class="fas fa-video"></i> Toggle Camera
                        </button>
                        <button id="toggleAudio">
                            <i class="fas fa-microphone"></i> Toggle Audio
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="info-section">
                <div class="status-panel">
                    <h3><i class="fas fa-info-circle"></i> System Status</h3>
                    <div class="status-grid">
                        <div class="status-item">
                            <i class="fas fa-video status-icon" id="cameraIcon"></i>
                            <div>Camera</div>
                            <div id="cameraStatus">Disabled</div>
                        </div>
                        <div class="status-item">
                            <i class="fas fa-microphone status-icon" id="audioIcon"></i>
                            <div>Audio</div>
                            <div id="audioStatus">Disabled</div>
                        </div>
                        <div class="status-item">
                            <i class="fas fa-running status-icon" id="motionIcon"></i>
                            <div>Motion</div>
                            <div id="motionStatus">No Motion</div>
                        </div>
                        <div class="status-item">
                            <i class="fas fa-smile status-icon" id="emotionIcon"></i>
                            <div>Emotion</div>
                            <div id="emotionStatus">None</div>
                        </div>
                    </div>
                </div>
                
                <div class="detection-panel">
                    <h3><i class="fas fa-user-check"></i> Detection Results</h3>
                    <div class="detection-info">
                        <div class="detection-item">
                            <span>People Detected:</span>
                            <span id="peopleCount">0</span>
                        </div>
                        <div class="detection-item">
                            <span>Current Sound:</span>
                            <span id="soundType">None</span>
                        </div>
                        <div class="detection-item">
                            <span>Emotion Detected:</span>
                            <span id="emotionType">None</span>
                        </div>
                    </div>
                    <canvas id="waveform"></canvas>
                </div>
                
                <div class="alerts-panel">
                    <h3><i class="fas fa-bell"></i> Recent Alerts</h3>
                    <div id="alertsList" class="alerts-list">
                        <!-- Alerts will be added here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="errorMessage"></div>

    <script>
<<<<<<< HEAD
        // Initialize Socket.IO with error handling
        const socket = io({
            reconnection: true,
            reconnectionAttempts: 5,
            reconnectionDelay: 1000
        });

        // Socket.IO connection handling
        socket.on('connect', () => {
            console.log('Connected to server');
            updateConnectionStatus(true);
        });

        socket.on('disconnect', () => {
            console.log('Disconnected from server');
            updateConnectionStatus(false);
        });

        socket.on('connect_error', (error) => {
            console.error('Connection error:', error);
            updateConnectionStatus(false);
        });

        // Update video feed
        socket.on('frame', function(data) {
            if (data && data.data) {
                const videoFeed = document.getElementById('videoFeed');
                if (videoFeed) {
                    videoFeed.src = 'data:image/jpeg;base64,' + data.data;
                }
            }
        });

        {% if dev_mode %}
        // Initialize waveform visualization
        const waveformCanvas = document.getElementById('waveformCanvas');
=======
        const socket = io();
        const videoFeed = document.getElementById('videoFeed');
        const cameraPlaceholder = document.getElementById('cameraPlaceholder');
        const cameraSelect = document.getElementById('cameraSelect');
        const resolutionSelect = document.getElementById('resolutionSelect');
        const toggleCamera = document.getElementById('toggleCamera');
        const toggleAudio = document.getElementById('toggleAudio');
        const errorMessage = document.getElementById('errorMessage');
        const waveformCanvas = document.getElementById('waveform');
>>>>>>> e70735e7e6333c9ae4fd667977a0eab0cebd9541
        const waveformCtx = waveformCanvas.getContext('2d');
        const alertsList = document.getElementById('alertsList');

<<<<<<< HEAD
        // Handle waveform updates
        socket.on('waveform', function(data) {
            drawWaveform(data.data);
        });

        function drawWaveform(data) {
            const ctx = waveformCtx;
            const width = waveformCanvas.width;
            const height = waveformCanvas.height;
            const centerY = height / 2;
            
            ctx.clearRect(0, 0, width, height);
            ctx.beginPath();
            ctx.strokeStyle = '#3498db';
            ctx.lineWidth = 2;
            
            const step = width / data.length;
            
            ctx.moveTo(0, centerY + (data[0] * centerY));
            for (let i = 1; i < data.length; i++) {
                ctx.lineTo(i * step, centerY + (data[i] * centerY));
            }
            ctx.stroke();
        }
        {% endif %}

        // Handle alerts
        socket.on('alert', function(data) {
            const alertContainer = document.getElementById('alertContainer');
            if (!alertContainer) return;

            const alertDiv = document.createElement('div');
            alertDiv.className = `alert-item alert-${data.level}`;
            alertDiv.innerHTML = `
                <div class="alert-timestamp">${new Date().toLocaleTimeString()}</div>
                <div>${data.message}</div>
            `;
            alertContainer.insertBefore(alertDiv, alertContainer.firstChild);
            
            // Limit number of alerts
            while (alertContainer.children.length > 50) {
                alertContainer.removeChild(alertContainer.lastChild);
            }
        });

        // Handle emotion updates
        socket.on('emotion', function(data) {
            updateEmotion(data);
        });

        // Handle status updates
        socket.on('status', function(data) {
            updateStatus(data.data);
        });

        function updateStatus(status) {
            updateStatusIndicator('cameraStatus', status.camera_enabled);
            updateStatusIndicator('audioStatus', status.audio_enabled);
            updateStatusIndicator('emotionStatus', status.emotion_enabled);
            updateStatusIndicator('personStatus', status.detection_enabled);
        }

        function updateStatusIndicator(id, isActive) {
            const indicator = document.getElementById(id);
            if (indicator) {
                indicator.className = 'status-indicator ' + (isActive ? 'status-active' : 'status-inactive');
            }
        }

        function updateConnectionStatus(isConnected) {
            updateStatusIndicator('connectionStatus', isConnected);
        }

        function updateEmotion(data) {
            const emotionLabel = document.getElementById('emotionLabel');
            const confidenceFill = document.getElementById('confidenceFill');
            
            if (emotionLabel && confidenceFill && data.emotion) {
                emotionLabel.textContent = `Current Emotion: ${data.emotion}`;
                confidenceFill.style.width = `${data.confidence * 100}%`;
            }
        }

        // Control buttons
        document.getElementById('toggleCamera').addEventListener('click', function() {
            fetch('/control/toggle_camera', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        updateStatus({ camera_enabled: data.camera_enabled });
                    }
                })
                .catch(error => console.error('Error:', error));
        });

        document.getElementById('toggleAudio').addEventListener('click', function() {
            fetch('/control/toggle_audio', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        updateStatus({ audio_enabled: data.audio_enabled });
                    }
                })
                .catch(error => console.error('Error:', error));
        });

        // Initial status check
        fetch('/status')
            .then(response => response.json())
            .then(data => {
                if (!data.error) {
                    updateStatus(data);
                }
            })
            .catch(error => console.error('Error:', error));
=======
        let isConnected = false;
        let isCameraEnabled = false;
        let isAudioEnabled = false;

        // Socket connection handling
        socket.on('connect', () => {
            isConnected = true;
            updateStatus();
            fetchCameras();
        });

        socket.on('disconnect', () => {
            isConnected = false;
            updateStatus();
            showError('Connection lost. Reconnecting...');
        });

        // Camera handling
        function fetchCameras() {
            socket.emit('get_cameras', {}, (response) => {
                if (response.success) {
                    populateCameraSelect(response.cameras);
                } else {
                    showError('Failed to fetch cameras: ' + response.error);
                }
            });
        }

        function populateCameraSelect(cameras) {
            cameraSelect.innerHTML = '<option value="">Select Camera</option>';
            cameras.forEach(camera => {
                const option = document.createElement('option');
                option.value = camera.id;
                option.textContent = camera.name;
                option.dataset.resolutions = JSON.stringify(camera.resolutions);
                cameraSelect.appendChild(option);
            });
        }

        function updateResolutionSelect(resolutions) {
            resolutionSelect.innerHTML = '<option value="">Select Resolution</option>';
            resolutions.forEach(resolution => {
                const option = document.createElement('option');
                option.value = `${resolution.width}x${resolution.height}`;
                option.textContent = `${resolution.width}x${resolution.height}`;
                resolutionSelect.appendChild(option);
            });
        }

        // Event listeners
        cameraSelect.addEventListener('change', () => {
            const selectedOption = cameraSelect.selectedOptions[0];
            if (selectedOption && selectedOption.dataset.resolutions) {
                const resolutions = JSON.parse(selectedOption.dataset.resolutions);
                updateResolutionSelect(resolutions);
                socket.emit('select_camera', { camera_id: selectedOption.value });
            }
        });

        resolutionSelect.addEventListener('change', () => {
            const [width, height] = resolutionSelect.value.split('x').map(Number);
            socket.emit('set_resolution', { width, height });
        });

        toggleCamera.addEventListener('click', () => {
            socket.emit('toggle_camera');
        });

        toggleAudio.addEventListener('click', () => {
            socket.emit('toggle_audio');
        });

        // Status updates
        socket.on('status', (data) => {
            isCameraEnabled = data.camera_enabled;
            isAudioEnabled = data.audio_enabled;
            updateStatus();
            
            // Update status icons and text
            updateStatusItem('camera', isCameraEnabled);
            updateStatusItem('audio', isAudioEnabled);
            updateStatusItem('motion', data.motion_detected);
            updateStatusItem('emotion', data.emotion_detected);
            
            if (!isCameraEnabled) {
                videoFeed.style.display = 'none';
                cameraPlaceholder.style.display = 'block';
            } else {
                videoFeed.style.display = 'block';
                cameraPlaceholder.style.display = 'none';
            }
        });

        // Detection updates
        socket.on('detection', (data) => {
            document.getElementById('peopleCount').textContent = data.people_count || 0;
            if (data.sound_type) {
                document.getElementById('soundType').textContent = data.sound_type;
            }
            if (data.emotion) {
                document.getElementById('emotionType').textContent = `${data.emotion} (${(data.confidence * 100).toFixed(1)}%)`;
            }
        });

        // Frame updates
        socket.on('frame', (data) => {
            if (data && data.data) {
                videoFeed.src = `data:image/jpeg;base64,${data.data}`;
            }
        });

        // Alert handling
        socket.on('alert', (data) => {
            addAlert(data);
        });

        function addAlert(alert) {
            const alertElement = document.createElement('div');
            alertElement.className = `alert-item ${alert.level}`;
            alertElement.innerHTML = `
                <div class="alert-time">${alert.timestamp}</div>
                <div>${alert.message}</div>
            `;
            alertsList.insertBefore(alertElement, alertsList.firstChild);
            
            // Limit number of alerts
            while (alertsList.children.length > 10) {
                alertsList.removeChild(alertsList.lastChild);
            }
        }

        // Audio visualization
        socket.on('audio_data', (data) => {
            drawWaveform(data.samples);
        });

        function drawWaveform(samples) {
            const canvas = waveformCanvas;
            const ctx = waveformCtx;
            const width = canvas.width;
            const height = canvas.height;

            ctx.fillStyle = '#333';
            ctx.fillRect(0, 0, width, height);
            ctx.beginPath();
            ctx.strokeStyle = '#007bff';
            ctx.lineWidth = 2;

            const step = Math.floor(samples.length / width);
            const amp = height / 2;

            for (let i = 0; i < width; i++) {
                const x = i;
                const y = (samples[i * step] * amp) + (height / 2);
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }

            ctx.stroke();
        }

        function updateStatusItem(type, isActive) {
            const icon = document.getElementById(`${type}Icon`);
            const status = document.getElementById(`${type}Status`);
            
            icon.classList.toggle('active', isActive);
            icon.classList.toggle('inactive', !isActive);
            
            switch (type) {
                case 'camera':
                    status.textContent = isActive ? 'Active' : 'Disabled';
                    break;
                case 'audio':
                    status.textContent = isActive ? 'Active' : 'Disabled';
                    break;
                case 'motion':
                    status.textContent = isActive ? 'Detected' : 'No Motion';
                    break;
                case 'emotion':
                    status.textContent = isActive ? 'Detected' : 'None';
                    break;
            }
        }

        function updateStatus() {
            toggleCamera.disabled = !isConnected;
            toggleAudio.disabled = !isConnected;
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 5000);
        }

        // Handle window resize for canvas
        function resizeCanvas() {
            waveformCanvas.width = waveformCanvas.offsetWidth;
            waveformCanvas.height = waveformCanvas.offsetHeight;
        }

        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();
>>>>>>> e70735e7e6333c9ae4fd667977a0eab0cebd9541
    </script>
</body>
</html> 