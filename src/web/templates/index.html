<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baby Monitor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #1a1a1a;
            color: #ffffff;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }
        
        .video-section {
            background: #2d2d2d;
            padding: 20px;
            border-radius: 10px;
        }
        
        .info-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .status-panel, .detection-panel, .alerts-panel {
            background: #2d2d2d;
            padding: 20px;
            border-radius: 10px;
        }
        
        .video-container {
            position: relative;
            width: 100%;
            padding-bottom: 75%;
        }
        
        .video-feed {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .control-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #444;
            background: #333;
            color: white;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            background: #007bff;
            color: white;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        button:disabled {
            background: #444;
            cursor: not-allowed;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .status-item {
            background: #333;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .status-icon {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .status-icon.active {
            color: #28a745;
        }
        
        .status-icon.inactive {
            color: #dc3545;
        }
        
        .detection-info {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            background: #f8f9fa;
        }
        
        .detection-item {
            background: #333;
            padding: 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .alerts-list {
            max-height: 300px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .alert-item {
            background: #333;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid;
        }
        
        .alert-item.critical {
            border-color: #dc3545;
        }
        
        .alert-item.warning {
            border-color: #ffc107;
        }
        
        .alert-item.info {
            border-color: #17a2b8;
        }
        
        .alert-time {
            font-size: 0.8em;
            color: #888;
        }
        
        .waveform-container {
            width: 100%;
            height: 150px;
            background: #f8f9fa;
            margin-top: 20px;
            position: relative;
        }
        
        #waveformCanvas {
            width: 100%;
            height: 100%;
        }
        
        .placeholder {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: white;
            display: none;
        }
        
        #errorMessage {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #dc3545;
            color: white;
            padding: 15px;
            border-radius: 8px;
            display: none;
            z-index: 1000;
        }
        
        .status-active { color: #28a745; }
        .status-inactive { color: #dc3545; }
        .status-warning { color: #ffc107; }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-content">
            <div class="video-section">
                <div class="video-container">
                    <img id="videoFeed" class="video-feed">
                    <div class="placeholder" id="cameraPlaceholder">
                        <i class="fas fa-video-slash"></i>
                        <p>Camera is disabled</p>
                    </div>
                </div>
                
                <div class="controls">
                    <div class="control-group">
                        <select id="cameraSelect">
                            <option value="">Select Camera</option>
                        </select>
                        <select id="resolutionSelect">
                            <option value="">Select Resolution</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <button id="toggleCamera">
                            <i class="fas fa-video"></i> Toggle Camera
                        </button>
                        <button id="toggleAudio">
                            <i class="fas fa-microphone"></i> Toggle Audio
                        </button>
                    </div>
                </div>
                
                <div class="waveform-container">
                    <canvas id="waveformCanvas"></canvas>
                    <div class="placeholder" id="audioPlaceholder">
                        <i class="fas fa-volume-mute"></i>
                        <p>Audio is disabled</p>
                    </div>
                </div>
            </div>
            
            <div class="info-section">
                <div class="status-panel">
                    <h3><i class="fas fa-info-circle"></i> System Status</h3>
                    <div class="status-grid">
                        <div class="status-item">
                            <i class="fas fa-video status-icon" id="cameraIcon"></i>
                            <div>Camera</div>
                            <div id="cameraStatus">Disabled</div>
                        </div>
                        <div class="status-item">
                            <i class="fas fa-microphone status-icon" id="audioIcon"></i>
                            <div>Audio</div>
                            <div id="audioStatus">Disabled</div>
                        </div>
                        <div class="status-item">
                            <i class="fas fa-running status-icon" id="motionIcon"></i>
                            <div>Motion</div>
                            <div id="motionStatus">No Motion</div>
                        </div>
                        <div class="status-item">
                            <i class="fas fa-smile status-icon" id="emotionIcon"></i>
                            <div>Emotion</div>
                            <div id="emotionStatus">None</div>
                        </div>
                    </div>
                </div>
                
                <div class="detection-panel">
                    <h3><i class="fas fa-user-check"></i> Detection Results</h3>
                    <div class="detection-info">
                        <div class="d-flex align-items-center mb-2">
                            <span class="status-icon" id="peopleIcon">ðŸ‘¥</span>
                            <span>People Detected: <span id="peopleCount">0</span></span>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <span class="status-icon" id="motionIcon">ðŸ”„</span>
                            <span>Motion Status: <span id="motionStatus">No Motion</span></span>
                        </div>
                        <div class="d-flex align-items-center">
                            <span class="status-icon" id="soundIcon">ðŸ”Š</span>
                            <span>Sound Status: <span id="soundStatus">No Sound</span></span>
                        </div>
                    </div>
                </div>
                
                <div class="alerts-panel">
                    <h3><i class="fas fa-bell"></i> Recent Alerts</h3>
                    <div id="alertsList" class="alerts-list">
                        <!-- Alerts will be added here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="errorMessage"></div>

    <script>
        const socket = io();
        const videoFeed = document.getElementById('videoFeed');
        const cameraPlaceholder = document.getElementById('cameraPlaceholder');
        const cameraSelect = document.getElementById('cameraSelect');
        const resolutionSelect = document.getElementById('resolutionSelect');
        const toggleCamera = document.getElementById('toggleCamera');
        const toggleAudio = document.getElementById('toggleAudio');
        const errorMessage = document.getElementById('errorMessage');
        const waveformCanvas = document.getElementById('waveformCanvas');
        const waveformCtx = waveformCanvas.getContext('2d');
        const alertsList = document.getElementById('alertsList');

        // Initialize canvas size
        function initializeCanvas() {
            const container = waveformCanvas.parentElement;
            waveformCanvas.width = container.offsetWidth;
            waveformCanvas.height = container.offsetHeight;
        }
        
        // Call on load and resize
        window.addEventListener('load', initializeCanvas);
        window.addEventListener('resize', initializeCanvas);

        let isConnected = false;
        let isCameraEnabled = false;
        let isAudioEnabled = false;

        // Fetch available cameras on connection
        socket.on('connect', () => {
            console.log('Connected to server');
            fetchCameras();
        });

        function fetchCameras() {
            socket.emit('get_cameras', {}, (response) => {
                if (response.success) {
                    populateCameraSelect(response.cameras);
                } else {
                    showError(response.error || 'Failed to get cameras');
                }
            });
        }

        function populateCameraSelect(cameras) {
            cameraSelect.innerHTML = '<option value="">Select Camera</option>';
            cameras.forEach(camera => {
                const option = document.createElement('option');
                option.value = camera.id;
                option.textContent = camera.name;
                option.dataset.resolutions = JSON.stringify(camera.resolutions);
                cameraSelect.appendChild(option);
            });

            // If there's only one camera, select it automatically
            if (cameras.length === 1) {
                cameraSelect.value = cameras[0].id;
                const event = new Event('change');
                cameraSelect.dispatchEvent(event);
            }
        }

        function updateResolutionSelect(resolutions) {
            resolutionSelect.innerHTML = '<option value="">Select Resolution</option>';
            resolutions.forEach(resolution => {
                const option = document.createElement('option');
                const value = `${resolution.width}x${resolution.height}`;
                option.value = value;
                option.textContent = value;
                resolutionSelect.appendChild(option);
            });
        }

        // Event listeners
        cameraSelect.addEventListener('change', () => {
            const selectedOption = cameraSelect.selectedOptions[0];
            if (selectedOption && selectedOption.value) {
                socket.emit('select_camera', { camera_name: selectedOption.value }, (response) => {
                    if (response.success) {
                const resolutions = JSON.parse(selectedOption.dataset.resolutions);
                updateResolutionSelect(resolutions);
                        showSuccess(response.message || 'Camera selected successfully');
                    } else {
                        showError(response.error || 'Failed to select camera');
                    }
                });
            }
        });

        resolutionSelect.addEventListener('change', () => {
            const resolution = resolutionSelect.value;
            if (resolution) {
                const [width, height] = resolution.split('x').map(Number);
                socket.emit('set_resolution', { width, height }, (response) => {
                    if (response.success) {
                        showSuccess(response.message || 'Resolution set successfully');
                    } else {
                        showError(response.error || 'Failed to set resolution');
                    }
                });
            }
        });

        toggleCamera.addEventListener('click', () => {
            socket.emit('toggle_camera', {}, (response) => {
                if (!response.success) {
                    showError(response.error || 'Failed to toggle camera');
                }
            });
        });

        toggleAudio.addEventListener('click', () => {
            socket.emit('toggle_audio', {}, (response) => {
                if (!response.success) {
                    showError(response.error || 'Failed to toggle audio');
                }
            });
        });

        // Status updates
        socket.on('status', (data) => {
            isCameraEnabled = data.camera_enabled;
            isAudioEnabled = data.audio_enabled;
            updateUI();
        });

        // Detection updates
        socket.on('detection', (data) => {
            // Update people count
            document.getElementById('peopleCount').textContent = data.people_count || 0;
            
            // Update motion status
            const motionIcon = document.getElementById('motionIcon');
            const motionStatus = document.getElementById('motionStatus');
            
            if (data.motion_status === 'Rapid Motion') {
                motionIcon.classList.add('active');
                motionIcon.classList.remove('inactive');
                motionStatus.textContent = 'Rapid Motion';
                motionStatus.style.color = '#ff9800';  // Orange for rapid motion
            } else if (data.motion_status === 'Motion Detected') {
                motionIcon.classList.add('active');
                motionIcon.classList.remove('inactive');
                motionStatus.textContent = 'Motion Detected';
                motionStatus.style.color = '#4CAF50';  // Green for normal motion
            } else {
                motionIcon.classList.add('inactive');
                motionIcon.classList.remove('active');
                motionStatus.textContent = 'No Motion';
                motionStatus.style.color = '';  // Default color
            }
            
            // Handle fall detection
            if (data.fall_detected) {
                showError('ALERT: Fall detected!');
                // Add fall detection alert to the alerts list
                addAlert('Fall detected!', 'critical');
            }
        });

        socket.on('audio_detection', (data) => {
            document.getElementById('soundStatus').textContent = data.sound_type || 'None';
            if (data.sound_type && data.sound_type !== 'None') {
                document.getElementById('soundIcon').style.color = '#dc3545';
            } else {
                document.getElementById('soundIcon').style.color = '#6c757d';
            }
        });

        socket.on('emotion', (data) => {
            const emotion = data.emotion || 'None';
            const confidence = data.confidence ? `(${Math.round(data.confidence * 100)}%)` : '';
            document.getElementById('emotionStatus').textContent = emotion;
            if (emotion !== 'None') {
                document.getElementById('emotionIcon').classList.add('active');
                document.getElementById('emotionIcon').classList.remove('inactive');
            } else {
                document.getElementById('emotionIcon').classList.add('inactive');
                document.getElementById('emotionIcon').classList.remove('active');
            }
        });

        socket.on('waveform', (data) => {
            if (data.data && waveformCtx) {
                waveformCtx.clearRect(0, 0, waveformCanvas.width, waveformCanvas.height);
                waveformCtx.fillStyle = '#f8f9fa';
                waveformCtx.fillRect(0, 0, waveformCanvas.width, waveformCanvas.height);
                
                const samples = data.data;
                const width = waveformCanvas.width;
                const height = waveformCanvas.height;
                const step = Math.ceil(samples.length / width);
                const amp = height / 2;
                
                waveformCtx.beginPath();
                waveformCtx.strokeStyle = '#007bff';
                waveformCtx.lineWidth = 2;
                
                for (let i = 0; i < width; i++) {
                    const x = i;
                    const y = (samples[i * step] * amp) + (height / 2);
                    waveformCtx.lineTo(x, y);
                }
                
                waveformCtx.stroke();
            }
        });

        socket.on('frame', (data) => {
            if (data.data) {
                const img = new Image();
                img.onload = () => {
                    videoFeed.src = img.src;
                    videoFeed.style.display = 'block';
                    cameraPlaceholder.style.display = 'none';
                };
                img.src = 'data:image/jpeg;base64,' + data.data;
            }
        });

        function updateUI() {
            if (isCameraEnabled) {
                toggleCamera.querySelector('i').className = 'fas fa-video';
                if (videoFeed.src) {
                    videoFeed.style.display = 'block';
                    cameraPlaceholder.style.display = 'none';
                } else {
                    videoFeed.style.display = 'none';
                    cameraPlaceholder.style.display = 'flex';
                }
            } else {
                toggleCamera.querySelector('i').className = 'fas fa-video-slash';
                videoFeed.style.display = 'none';
                cameraPlaceholder.style.display = 'flex';
            }

            toggleAudio.querySelector('i').className = isAudioEnabled ? 'fas fa-microphone' : 'fas fa-microphone-slash';
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 5000);
        }

        function showSuccess(message) {
            errorMessage.textContent = message;
            errorMessage.style.backgroundColor = '#4CAF50';
            errorMessage.style.display = 'block';
            setTimeout(() => {
                errorMessage.style.display = 'none';
                errorMessage.style.backgroundColor = '#f44336';
            }, 3000);
        }

        // Alert handling
        socket.on('alert', (data) => {
            addAlert(data.level, data.message);
        });

        function addAlert(level, message) {
            const alertsList = document.getElementById('alertsList');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${level === 'critical' ? 'danger' : 'info'} mb-2`;
            
            const time = new Date().toLocaleTimeString();
            alertDiv.innerHTML = `
                <div class="alert-time">${time}</div>
                <div class="alert-message">${message}</div>
            `;
            
            // Add to the beginning of the list
            alertsList.insertBefore(alertDiv, alertsList.firstChild);
            
            // Limit the number of alerts
            while (alertsList.children.length > 10) {
                alertsList.removeChild(alertsList.lastChild);
            }
        }

        // Initialize UI
        updateUI();
    </script>
</body>
</html> 