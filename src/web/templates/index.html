<!DOCTYPE html>
<html lang="en">
<head>
    // ... existing head content ...
</head>
<body>
    <!-- Add loading overlay -->
    <div class="model-loading" id="modelLoading">
        <div class="spinner"></div>
        <div id="modelLoadingText">Loading model...</div>
    </div>

    <div class="container">
        <div class="main-content">
            {% if not no_feed %}
            <div class="video-section">
                <div class="video-container">
                    <img id="videoFeed" class="video-feed">
                    <div class="placeholder" id="cameraPlaceholder">
                        <i class="fas fa-video-slash"></i>
                        <p>Camera is disabled</p>
                    </div>
                </div>
                
                <div class="controls">
                    <div class="control-group">
                        <select id="cameraSelect">
                            <option value="">Select Camera</option>
                        </select>
                        <select id="resolutionSelect">
                            <option value="">Select Resolution</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <button id="toggleCamera">
                            <i class="fas fa-video"></i> Toggle Camera
                        </button>
                        <button id="toggleAudio">
                            <i class="fas fa-microphone"></i> Toggle Audio
                        </button>
                    </div>
                </div>
                
                {% if not no_waveform %}
                <div class="waveform-container">
                    <canvas id="waveformCanvas"></canvas>
                    <div class="placeholder" id="audioPlaceholder">
                        <i class="fas fa-volume-mute"></i>
                        <p>Audio is disabled</p>
                    </div>
                </div>
                {% endif %}
            </div>
            {% endif %}
            
            <div class="info-section">
                // ... rest of the existing content ...
            </div>
        </div>
    </div>
    
    <div id="errorMessage"></div>

    <script>
        // Initialize Socket.IO with error handling
        const socket = io({
            reconnection: true,
            reconnectionAttempts: 5,
            reconnectionDelay: 1000
        });

        // Socket.IO connection handling
        socket.on('connect', () => {
            console.log('Connected to server');
            updateConnectionStatus(true);
        });

        socket.on('disconnect', () => {
            console.log('Disconnected from server');
            updateConnectionStatus(false);
        });

        socket.on('connect_error', (error) => {
            console.error('Connection error:', error);
            updateConnectionStatus(false);
        });

        {% if not no_feed %}
        // Update video feed
        socket.on('frame', function(data) {
            if (data && data.data) {
                const videoFeed = document.getElementById('videoFeed');
                if (videoFeed) {
                    videoFeed.src = 'data:image/jpeg;base64,' + data.data;
                }
            }
        });
        {% endif %}

        {% if not no_waveform %}
        // Initialize waveform visualization
        const waveformCanvas = document.getElementById('waveformCanvas');
        const waveformCtx = waveformCanvas.getContext('2d');

        // Initialize canvas size
        function initializeCanvas() {
            const container = waveformCanvas.parentElement;
            waveformCanvas.width = container.offsetWidth;
            waveformCanvas.height = container.offsetHeight;
        }
        
        // Call on load and resize
        window.addEventListener('load', initializeCanvas);
        window.addEventListener('resize', initializeCanvas);

        socket.on('waveform', function(data) {
            if (data.data && waveformCtx) {
                drawWaveform(data.data);
            }
        });

        function drawWaveform(data) {
            waveformCtx.clearRect(0, 0, waveformCanvas.width, waveformCanvas.height);
            waveformCtx.fillStyle = '#f8f9fa';
            waveformCtx.fillRect(0, 0, waveformCanvas.width, waveformCanvas.height);
            
            const width = waveformCanvas.width;
            const height = waveformCanvas.height;
            const step = Math.ceil(data.length / width);
            const amp = height / 2;
            
            waveformCtx.beginPath();
            waveformCtx.strokeStyle = '#007bff';
            waveformCtx.lineWidth = 2;
            
            for (let i = 0; i < width; i++) {
                const x = i;
                const y = (data[i * step] * amp) + (height / 2);
                if (i === 0) {
                    waveformCtx.moveTo(x, y);
                } else {
                    waveformCtx.lineTo(x, y);
                }
            }
            
            waveformCtx.stroke();
        }
        {% endif %}

        // ... rest of the existing JavaScript code ...
    </script>
</body>
</html> 